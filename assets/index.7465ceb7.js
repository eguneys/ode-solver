var Uo=Object.defineProperty;var Do=(t,e,r)=>e in t?Uo(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var ct=(t,e,r)=>(Do(t,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const Yt=1e3/60,zo={seconds:60*Yt,half:30*Yt,thirds:20*Yt,lengths:15*Yt,sixth:10*Yt,five:5*Yt,three:3*Yt,one:1*Yt},Pi=class{constructor(e,r,i){ct(this,"ctx");this.width=e,this.height=r,this.canvas=i,this.ctx=i.getContext("2d")}clear(){this.ctx.clearRect(0,0,this.width,this.height)}tr(e,r,i,o,a){this.ctx.translate(e,r),this.ctx.rotate(a),this.ctx.translate(-i,-o)}resetTransform(){this.ctx.resetTransform()}fr(e,r,i,o,a){this.ctx.fillStyle=e,this.ctx.fillRect(r,i,o,a)}line(e,r,i,o,a,n){this.ctx.strokeStyle=e,this.ctx.lineWidth=r,this.ctx.beginPath(),this.ctx.moveTo(i,o),this.ctx.lineTo(a,n),this.ctx.closePath(),this.ctx.stroke()}};let vr=Pi;ct(vr,"make",(e,r,i)=>{let o=document.createElement("canvas");return o.width=e,o.height=r,i.appendChild(o),new Pi(e,r,o)});const Zi=t=>{let e,r=0;function i(o){let a=o-(r||o);r=o,a=Math.max(Math.min(a,16),4),t(a),e=requestAnimationFrame(i)}return e=requestAnimationFrame(i),()=>{cancelAnimationFrame(e)}},H=class{constructor(e,r){ct(this,"x");ct(this,"y");this.x=e,this.y=r}get key(){return[this.x,this.y].join(";")}static get unit(){return new H(1,1)}static get zero(){return new H(0,0)}static get left(){return new H(-1,0)}static get right(){return new H(1,0)}static get up(){return new H(0,-1)}static get down(){return new H(0,1)}get neighbours(){return[H.up,H.down,H.left,H.right].map(e=>e.add(this))}get right(){return H.right.add(this)}get left(){return H.left.add(this)}get up(){return H.up.add(this)}get down(){return H.down.add(this)}get vs(){return[this.x,this.y]}get mul_inverse(){return new H(1/this.x,1/this.y)}get inverse(){return new H(-this.x,-this.y)}get half(){return new H(this.x/2,this.y/2)}get length_squared(){return this.x*this.x+this.y*this.y}get length(){return Math.sqrt(this.length_squared)}get normalize(){if(this.length!==0)return this.scale(1/this.length)}get perpendicular(){return new H(-this.y,this.x)}get clone(){return new H(this.x,this.y)}get angle(){return Math.atan2(this.y,this.x)}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}project_to(e){let r=e.length_squared,i=this.dot(e);return H.make(i*e.x/r,i*e.y/r)}distance(e){return this.sub(e).length}addy(e){return H.make(this.x,this.y+e)}add_angle(e){return H.from_angle(this.angle+e)}scale(e){let{clone:r}=this;return r.scale_in(e)}scale_in(e){return this.x*=e,this.y*=e,this}add(e){let{clone:r}=this;return r.add_in(e)}add_in(e){return this.x+=e.x,this.y+=e.y,this}sub(e){let{clone:r}=this;return r.sub_in(e)}sub_in(e){return this.x-=e.x,this.y-=e.y,this}mul(e){let{clone:r}=this;return r.mul_in(e)}mul_in(e){return this.x*=e.x,this.y*=e.y,this}div(e){let{clone:r}=this;return r.div_in(e)}div_in(e){return this.x/=e.x,this.y/=e.y,this}set_in(e,r=this.y){return this.x=e,this.y=r,this}};let Z=H;ct(Z,"from_key",e=>new H(parseFloat(e.split(";")[0]),parseFloat(e.split(";")[1]))),ct(Z,"from_angle",e=>new H(Math.cos(e),Math.sin(e))),ct(Z,"make",(e,r)=>new H(e,r));const Pe=class{constructor(e){this.vertices=e}static get unit(){return Pe.make(0,0,1,1)}get vs(){let{x:e,y:r,w:i,h:o}=this;return[e,r,i,o]}get x1(){return this.vertices[0].x}get y1(){return this.vertices[0].y}get x2(){return this.vertices[2].x}get y2(){return this.vertices[2].y}get x(){return this.x1}get y(){return this.y1}get w(){return this.x2-this.x1}get h(){return this.y2-this.y1}get center(){return Z.make(this.x+this.w/2,this.y+this.h/2)}get vertexData(){return new Float32Array(this.vertices.flatMap(e=>e.vs))}get indices(){return new Uint16Array([0,1,2,0,2,3])}larger(e){return Pe.make(this.x-e/2,this.y-e/2,this.w+e,this.h+e)}transform(e){return new Pe(this.vertices.map(r=>e.mVec2(r)))}};let Kt=Pe;ct(Kt,"make",(e,r,i,o)=>new Pe([Z.make(e,r),Z.make(e+i,r),Z.make(e+i,r+o),Z.make(e,r+o)]));const lt=class{constructor(e,r,i){ct(this,"x");ct(this,"y");ct(this,"z");this.x=e,this.y=r,this.z=i}static get unit(){return new lt(1,1,1)}static get zero(){return new lt(0,0,0)}static get down(){return new lt(0,1,0)}static get up(){return new lt(0,-1,0)}static get right(){return new lt(1,0,0)}static get left(){return new lt(-1,0,0)}get vs(){return[this.x,this.y,this.z]}get mul_inverse(){return new lt(1/this.x,1/this.y,1/this.z)}get inverse(){return new lt(-this.x,-this.y,-this.z)}get half(){return new lt(this.x/2,this.y/2,this.z/2)}get length_squared(){return this.x*this.x+this.y*this.y+this.z*this.z}get length(){return Math.sqrt(this.length_squared)}get normalize(){return this.length===0?lt.zero:this.scale(1/this.length)}get perpendicular(){return new lt(-this.y,this.x,this.z)}get clone(){return new lt(this.x,this.y,this.z)}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){return lt.make(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x)}distance(e){return this.sub(e).length}scale(e){let{clone:r}=this;return r.scale_in(e)}scale_in(e){return this.x*=e,this.y*=e,this.z*=e,this}add(e){let{clone:r}=this;return r.add_in(e)}add_in(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}sub(e){let{clone:r}=this;return r.sub_in(e)}sub_in(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}mul(e){let{clone:r}=this;return r.mul_in(e)}mul_in(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}div(e){let{clone:r}=this;return r.div_in(e)}div_in(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}set_in(e,r=this.y,i=this.z){return this.x=e,this.y=r,this.z=i,this}copy_in(e){return this.set_in(e.x,e.y,e.z)}};let Ue=lt;ct(Ue,"make",(e,r,i)=>new lt(e,r,i));function Wo(t){var e;return t.clientX!==void 0&&t.clientY!==void 0?[t.clientX,t.clientY]:(e=t.targetTouches)!=null&&e[0]?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:[0,0]}class Ji{}ct(Ji,"init",(e,r=document)=>{const i=d=>{let m=Wo(d);return m?Z.make(m[0],m[1]):Z.zero};let{_onDragStart:o,_onDragMove:a,_onDragEnd:n,_onContextMenu:s,_onWheel:c}=e;const l=d=>{o==null||o(i(d),d.buttons===2||d.button===2)},h=d=>{a==null||a(i(d))},p=d=>{n==null||n(i(d))},f=d=>{s&&(d.preventDefault(),s())},v=d=>{c==null||c(Math.sign(d.deltaY))};return r.addEventListener("wheel",v),r.addEventListener("touchstart",l,{passive:!1}),r.addEventListener("mousedown",l,{passive:!1}),r.addEventListener("contextmenu",f),document.addEventListener("mousemove",h,{passive:!1}),document.addEventListener("mouseup",p),document.addEventListener("touchmove",h,{passive:!1}),document.addEventListener("touchend",p),()=>{r.removeEventListener("wheel",v),r.removeEventListener("touchstart",l),r.removeEventListener("mousedown",l),r.removeEventListener("contextmenu",f),document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",p),document.removeEventListener("touchmove",h),document.removeEventListener("touchend",p)}});const Xo=(t,e)=>{let{on_hover:r,on_up:i,on_click:o,on_drag:a,on_context:n}=t,s,c,l,h;const p=f=>f&&{...f};return Ji.init({...n?{_onContextMenu(){n==null||n()}}:{},_onDragStart(f,v){c=p(s),s={e:f,_right:v},h&&(h==null||h()),h=Zi(d=>{s?((s.m||l&&s.e.distance(l)>3)&&(s.m=l),a==null||a(s,c),c=p(s)):h==null||h()})},_onDragMove(f){l=f,s||r==null||r(f)},_onDragEnd(){!s||(s.m||o==null||o(s.e,s._right),i==null||i(s.m||s.e,s._right),h==null||h(),h=void 0,s=void 0,l=void 0)}},e)},Ci=class{constructor(e){ct(this,"_bounds");this.$_=e}$clear_bounds(){this._bounds=void 0}get bounds(){return this._bounds||(this._bounds=this.$_.getBoundingClientRect()),this._bounds}get size(){let{bounds:e}=this;return Z.make(e.width,e.height)}get orig(){let{bounds:e}=this;return Z.make(e.x,e.y)}get_normal_at_abs_pos(e){let{orig:r,size:i}=this;return e.sub(r).div(i)}};let mr=Ci;ct(mr,"make",e=>new Ci(e));const Yo=t=>{document.addEventListener("scroll",t,{capture:!0,passive:!0}),window.addEventListener("resize",t,{passive:!0})};var rt={exports:{}},X={exports:{}},Vt=Zt;function Zt(){}Zt.appendArray=function(t,e){if(e.length<15e4)t.push.apply(t,e);else for(var r=0,i=e.length;r!==i;++r)t.push(e[r])};Zt.splice=function(t,e,r){r=r||1;for(var i=e,o=t.length-r;i<o;i++)t[i]=t[i+r];t.length=o};typeof P2_ARRAY_TYPE<"u"?Zt.ARRAY_TYPE=P2_ARRAY_TYPE:typeof Float32Array<"u"?Zt.ARRAY_TYPE=Float32Array:Zt.ARRAY_TYPE=Array;Zt.extend=function(t,e){for(var r in e)t[r]=e[r]};Zt.defaults=function(t,e){t=t||{};for(var r in e)r in t||(t[r]=e[r]);return t};var q=X.exports={},li=Vt;q.crossLength=function(t,e){return t[0]*e[1]-t[1]*e[0]};q.crossVZ=function(t,e,r){return q.rotate(t,e,-Math.PI/2),q.scale(t,t,r),t};q.crossZV=function(t,e,r){return q.rotate(t,r,Math.PI/2),q.scale(t,t,e),t};q.rotate=function(t,e,r){if(r!==0){var i=Math.cos(r),o=Math.sin(r),a=e[0],n=e[1];t[0]=i*a-o*n,t[1]=o*a+i*n}else t[0]=e[0],t[1]=e[1]};q.rotate90cw=function(t,e){var r=e[0],i=e[1];t[0]=i,t[1]=-r};q.toLocalFrame=function(t,e,r,i){q.copy(t,e),q.sub(t,t,r),q.rotate(t,t,-i)};q.toGlobalFrame=function(t,e,r,i){q.copy(t,e),q.rotate(t,t,i),q.add(t,t,r)};q.vectorToLocalFrame=function(t,e,r){q.rotate(t,e,-r)};q.vectorToGlobalFrame=function(t,e,r){q.rotate(t,e,r)};q.centroid=function(t,e,r,i){return q.add(t,e,r),q.add(t,t,i),q.scale(t,t,1/3),t};q.create=function(){var t=new li.ARRAY_TYPE(2);return t[0]=0,t[1]=0,t};q.clone=function(t){var e=new li.ARRAY_TYPE(2);return e[0]=t[0],e[1]=t[1],e};q.fromValues=function(t,e){var r=new li.ARRAY_TYPE(2);return r[0]=t,r[1]=e,r};q.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t};q.set=function(t,e,r){return t[0]=e,t[1]=r,t};q.add=function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t};q.subtract=function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t};q.sub=q.subtract;q.multiply=function(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t};q.mul=q.multiply;q.divide=function(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t};q.div=q.divide;q.scale=function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t};q.distance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)};q.dist=q.distance;q.squaredDistance=function(t,e){var r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i};q.sqrDist=q.squaredDistance;q.length=function(t){var e=t[0],r=t[1];return Math.sqrt(e*e+r*r)};q.len=q.length;q.squaredLength=function(t){var e=t[0],r=t[1];return e*e+r*r};q.sqrLen=q.squaredLength;q.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t};q.normalize=function(t,e){var r=e[0],i=e[1],o=r*r+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o),t};q.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]};q.str=function(t){return"vec2("+t[0]+", "+t[1]+")"};q.lerp=function(t,e,r,i){var o=e[0],a=e[1];return t[0]=o+i*(r[0]-o),t[1]=a+i*(r[1]-a),t};q.reflect=function(t,e,r){var i=e[0]*r[0]+e[1]*r[1];t[0]=e[0]-2*r[0]*i,t[1]=e[1]-2*r[1]*i};q.getLineSegmentsIntersection=function(t,e,r,i,o){var a=q.getLineSegmentsIntersectionFraction(e,r,i,o);return a<0?!1:(t[0]=e[0]+a*(r[0]-e[0]),t[1]=e[1]+a*(r[1]-e[1]),!0)};q.getLineSegmentsIntersectionFraction=function(t,e,r,i){var o=e[0]-t[0],a=e[1]-t[1],n=i[0]-r[0],s=i[1]-r[1],c,l;return c=(-a*(t[0]-r[0])+o*(t[1]-r[1]))/(-n*a+o*s),l=(n*(t[1]-r[1])-s*(t[0]-r[0]))/(-n*a+o*s),c>=0&&c<=1&&l>=0&&l<=1?l:-1};var Ct=X.exports,hi=ve;function ve(t){this.lowerBound=Ct.create(),t&&t.lowerBound&&Ct.copy(this.lowerBound,t.lowerBound),this.upperBound=Ct.create(),t&&t.upperBound&&Ct.copy(this.upperBound,t.upperBound)}var Lr=Ct.create();ve.prototype.setFromPoints=function(t,e,r,i){var o=this.lowerBound,a=this.upperBound;typeof r!="number"&&(r=0),r!==0?Ct.rotate(o,t[0],r):Ct.copy(o,t[0]),Ct.copy(a,o);for(var n=Math.cos(r),s=Math.sin(r),c=1;c<t.length;c++){var l=t[c];if(r!==0){var h=l[0],p=l[1];Lr[0]=n*h-s*p,Lr[1]=s*h+n*p,l=Lr}for(var f=0;f<2;f++)l[f]>a[f]&&(a[f]=l[f]),l[f]<o[f]&&(o[f]=l[f])}e&&(Ct.add(this.lowerBound,this.lowerBound,e),Ct.add(this.upperBound,this.upperBound,e)),i&&(this.lowerBound[0]-=i,this.lowerBound[1]-=i,this.upperBound[0]+=i,this.upperBound[1]+=i)};ve.prototype.copy=function(t){Ct.copy(this.lowerBound,t.lowerBound),Ct.copy(this.upperBound,t.upperBound)};ve.prototype.extend=function(t){for(var e=2;e--;){var r=t.lowerBound[e];this.lowerBound[e]>r&&(this.lowerBound[e]=r);var i=t.upperBound[e];this.upperBound[e]<i&&(this.upperBound[e]=i)}};ve.prototype.overlaps=function(t){var e=this.lowerBound,r=this.upperBound,i=t.lowerBound,o=t.upperBound;return(i[0]<=r[0]&&r[0]<=o[0]||e[0]<=o[0]&&o[0]<=r[0])&&(i[1]<=r[1]&&r[1]<=o[1]||e[1]<=o[1]&&o[1]<=r[1])};ve.prototype.containsPoint=function(t){var e=this.lowerBound,r=this.upperBound;return e[0]<=t[0]&&t[0]<=r[0]&&e[1]<=t[1]&&t[1]<=r[1]};ve.prototype.overlapsRay=function(t){var e=1/t.direction[0],r=1/t.direction[1],i=(this.lowerBound[0]-t.from[0])*e,o=(this.upperBound[0]-t.from[0])*e,a=(this.lowerBound[1]-t.from[1])*r,n=(this.upperBound[1]-t.from[1])*r,s=Math.max(Math.max(Math.min(i,o),Math.min(a,n))),c=Math.min(Math.min(Math.max(i,o),Math.max(a,n)));return c<0||s>c?-1:s};var Qi=ji;function ji(){}ji.eq=function(t,e,r){return r=r||0,Math.abs(t-e)<r};var Ho=Qi,Ko=ui;function ui(){}ui.lineInt=function(t,e,r){r=r||0;var i=[0,0],o,a,n,s,c,l,h;return o=t[1][1]-t[0][1],a=t[0][0]-t[1][0],n=o*t[0][0]+a*t[0][1],s=e[1][1]-e[0][1],c=e[0][0]-e[1][0],l=s*e[0][0]+c*e[0][1],h=o*c-s*a,Ho.eq(h,0,r)||(i[0]=(c*n-a*l)/h,i[1]=(o*l-s*n)/h),i};ui.segmentsIntersect=function(t,e,r,i){var o=e[0]-t[0],a=e[1]-t[1],n=i[0]-r[0],s=i[1]-r[1];if(n*a-s*o==0)return!1;var c=(o*(r[1]-t[1])+a*(t[0]-r[0]))/(n*a-s*o),l=(n*(t[1]-r[1])+s*(r[0]-t[0]))/(s*o-n*a);return c>=0&&c<=1&&l>=0&&l<=1};var to=wt;function wt(){}wt.area=function(t,e,r){return(e[0]-t[0])*(r[1]-t[1])-(r[0]-t[0])*(e[1]-t[1])};wt.left=function(t,e,r){return wt.area(t,e,r)>0};wt.leftOn=function(t,e,r){return wt.area(t,e,r)>=0};wt.right=function(t,e,r){return wt.area(t,e,r)<0};wt.rightOn=function(t,e,r){return wt.area(t,e,r)<=0};var Zo=[],Jo=[];wt.collinear=function(t,e,r,i){if(i){var o=Zo,a=Jo;o[0]=e[0]-t[0],o[1]=e[1]-t[1],a[0]=r[0]-e[0],a[1]=r[1]-e[1];var n=o[0]*a[0]+o[1]*a[1],s=Math.sqrt(o[0]*o[0]+o[1]*o[1]),c=Math.sqrt(a[0]*a[0]+a[1]*a[1]),l=Math.acos(n/(s*c));return l<i}else return wt.area(t,e,r)==0};wt.sqdist=function(t,e){var r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i};var Ur=Ko,j=to,Qo=Qi,jo=Q;function Q(){this.vertices=[]}Q.prototype.at=function(t){var e=this.vertices,r=e.length;return e[t<0?t%r+r:t%r]};Q.prototype.first=function(){return this.vertices[0]};Q.prototype.last=function(){return this.vertices[this.vertices.length-1]};Q.prototype.clear=function(){this.vertices.length=0};Q.prototype.append=function(t,e,r){if(typeof e>"u")throw new Error("From is not given!");if(typeof r>"u")throw new Error("To is not given!");if(r-1<e)throw new Error("lol1");if(r>t.vertices.length)throw new Error("lol2");if(e<0)throw new Error("lol3");for(var i=e;i<r;i++)this.vertices.push(t.vertices[i])};Q.prototype.makeCCW=function(){for(var t=0,e=this.vertices,r=1;r<this.vertices.length;++r)(e[r][1]<e[t][1]||e[r][1]==e[t][1]&&e[r][0]>e[t][0])&&(t=r);j.left(this.at(t-1),this.at(t),this.at(t+1))||this.reverse()};Q.prototype.reverse=function(){for(var t=[],e=0,r=this.vertices.length;e!==r;e++)t.push(this.vertices.pop());this.vertices=t};Q.prototype.isReflex=function(t){return j.right(this.at(t-1),this.at(t),this.at(t+1))};var ta=[],ea=[];Q.prototype.canSee=function(t,e){var r,i,o=ta,a=ea;if(j.leftOn(this.at(t+1),this.at(t),this.at(e))&&j.rightOn(this.at(t-1),this.at(t),this.at(e)))return!1;i=j.sqdist(this.at(t),this.at(e));for(var n=0;n!==this.vertices.length;++n)if(!((n+1)%this.vertices.length===t||n===t)&&j.leftOn(this.at(t),this.at(e),this.at(n+1))&&j.rightOn(this.at(t),this.at(e),this.at(n))&&(o[0]=this.at(t),o[1]=this.at(e),a[0]=this.at(n),a[1]=this.at(n+1),r=Ur.lineInt(o,a),j.sqdist(this.at(t),r)<i))return!1;return!0};Q.prototype.copy=function(t,e,r){var i=r||new Q;if(i.clear(),t<e)for(var o=t;o<=e;o++)i.vertices.push(this.vertices[o]);else{for(var o=0;o<=e;o++)i.vertices.push(this.vertices[o]);for(var o=t;o<this.vertices.length;o++)i.vertices.push(this.vertices[o])}return i};Q.prototype.getCutEdges=function(){for(var t=[],e=[],r=[],i=new Q,o=Number.MAX_VALUE,a=0;a<this.vertices.length;++a)if(this.isReflex(a)){for(var n=0;n<this.vertices.length;++n)if(this.canSee(a,n)){e=this.copy(a,n,i).getCutEdges(),r=this.copy(n,a,i).getCutEdges();for(var s=0;s<r.length;s++)e.push(r[s]);e.length<o&&(t=e,o=e.length,t.push([this.at(a),this.at(n)]))}}return t};Q.prototype.decomp=function(){var t=this.getCutEdges();return t.length>0?this.slice(t):[this]};Q.prototype.slice=function(t){if(t.length==0)return[this];if(t instanceof Array&&t.length&&t[0]instanceof Array&&t[0].length==2&&t[0][0]instanceof Array){for(var e=[this],r=0;r<t.length;r++)for(var i=t[r],o=0;o<e.length;o++){var a=e[o],n=a.slice(i);if(n){e.splice(o,1),e.push(n[0],n[1]);break}}return e}else{var i=t,r=this.vertices.indexOf(i[0]),o=this.vertices.indexOf(i[1]);return r!=-1&&o!=-1?[this.copy(r,o),this.copy(o,r)]:!1}};Q.prototype.isSimple=function(){for(var t=this.vertices,e=0;e<t.length-1;e++)for(var r=0;r<e-1;r++)if(Ur.segmentsIntersect(t[e],t[e+1],t[r],t[r+1]))return!1;for(var e=1;e<t.length-2;e++)if(Ur.segmentsIntersect(t[0],t[t.length-1],t[e],t[e+1]))return!1;return!0};function Li(t,e,r,i,o){o=o||0;var a=e[1]-t[1],n=t[0]-e[0],s=a*t[0]+n*t[1],c=i[1]-r[1],l=r[0]-i[0],h=c*r[0]+l*r[1],p=a*l-c*n;return Qo.eq(p,0,o)?[0,0]:[(l*s-n*h)/p,(a*h-c*s)/p]}Q.prototype.quickDecomp=function(t,e,r,i,o,a){o=o||100,a=a||0,i=i||25,t=typeof t<"u"?t:[],e=e||[],r=r||[];var n=[0,0],s=[0,0],c=[0,0],l=0,h=0,p=0,f=0,v=0,d=0,m=0,y=new Q,A=new Q,g=this,E=this.vertices;if(E.length<3)return t;if(a++,a>o)return console.warn("quickDecomp: max level ("+o+") reached."),t;for(var w=0;w<this.vertices.length;++w)if(g.isReflex(w)){e.push(g.vertices[w]),l=h=Number.MAX_VALUE;for(var B=0;B<this.vertices.length;++B)j.left(g.at(w-1),g.at(w),g.at(B))&&j.rightOn(g.at(w-1),g.at(w),g.at(B-1))&&(c=Li(g.at(w-1),g.at(w),g.at(B),g.at(B-1)),j.right(g.at(w+1),g.at(w),c)&&(p=j.sqdist(g.vertices[w],c),p<h&&(h=p,s=c,d=B))),j.left(g.at(w+1),g.at(w),g.at(B+1))&&j.rightOn(g.at(w+1),g.at(w),g.at(B))&&(c=Li(g.at(w+1),g.at(w),g.at(B),g.at(B+1)),j.left(g.at(w-1),g.at(w),c)&&(p=j.sqdist(g.vertices[w],c),p<l&&(l=p,n=c,v=B)));if(d==(v+1)%this.vertices.length)c[0]=(s[0]+n[0])/2,c[1]=(s[1]+n[1])/2,r.push(c),w<v?(y.append(g,w,v+1),y.vertices.push(c),A.vertices.push(c),d!=0&&A.append(g,d,g.vertices.length),A.append(g,0,w+1)):(w!=0&&y.append(g,w,g.vertices.length),y.append(g,0,v+1),y.vertices.push(c),A.vertices.push(c),A.append(g,d,w+1));else{if(d>v&&(v+=this.vertices.length),f=Number.MAX_VALUE,v<d)return t;for(var B=d;B<=v;++B)j.leftOn(g.at(w-1),g.at(w),g.at(B))&&j.rightOn(g.at(w+1),g.at(w),g.at(B))&&(p=j.sqdist(g.at(w),g.at(B)),p<f&&(f=p,m=B%this.vertices.length));w<m?(y.append(g,w,m+1),m!=0&&A.append(g,m,E.length),A.append(g,0,w+1)):(w!=0&&y.append(g,w,E.length),y.append(g,0,m+1),A.append(g,m,w+1))}return y.vertices.length<A.vertices.length?(y.quickDecomp(t,e,r,i,o,a),A.quickDecomp(t,e,r,i,o,a)):(A.quickDecomp(t,e,r,i,o,a),y.quickDecomp(t,e,r,i,o,a)),t}return t.push(this),t};Q.prototype.removeCollinearPoints=function(t){for(var e=0,r=this.vertices.length-1;this.vertices.length>3&&r>=0;--r)j.collinear(this.at(r-1),this.at(r),this.at(r+1),t)&&(this.vertices.splice(r%this.vertices.length,1),r--,e++);return e};var ra={Polygon:jo,Point:to},Nt=it,qi=X.exports;function it(t){t=t||{},this.body=null,this.position=qi.fromValues(0,0),t.position&&qi.copy(this.position,t.position),this.angle=t.angle||0,this.type=t.type||0,this.id=it.idCounter++,this.boundingRadius=0,this.collisionGroup=t.collisionGroup!==void 0?t.collisionGroup:1,this.collisionResponse=t.collisionResponse!==void 0?t.collisionResponse:!0,this.collisionMask=t.collisionMask!==void 0?t.collisionMask:1,this.material=t.material||null,this.area=0,this.sensor=t.sensor!==void 0?t.sensor:!1,this.type&&this.updateBoundingRadius(),this.updateArea()}it.idCounter=0;it.CIRCLE=1;it.PARTICLE=2;it.PLANE=4;it.CONVEX=8;it.LINE=16;it.BOX=32;Object.defineProperty(it,"RECTANGLE",{get:function(){return console.warn("Shape.RECTANGLE is deprecated, use Shape.BOX instead."),it.BOX}});it.CAPSULE=64;it.HEIGHTFIELD=128;it.prototype.computeMomentOfInertia=function(t){};it.prototype.updateBoundingRadius=function(){};it.prototype.updateArea=function(){};it.prototype.computeAABB=function(t,e,r){};it.prototype.raycast=function(t,e,r,i){};var ae={};ae.GetArea=function(t){if(t.length<6)return 0;for(var e=t.length-2,r=0,i=0;i<e;i+=2)r+=(t[i+2]-t[i])*(t[i+1]+t[i+3]);return r+=(t[0]-t[e])*(t[e+1]+t[1]),-r*.5};ae.Triangulate=function(t){var e=t.length>>1;if(e<3)return[];for(var r=[],i=[],o=0;o<e;o++)i.push(o);for(var o=0,a=e;a>3;){var n=i[(o+0)%a],s=i[(o+1)%a],c=i[(o+2)%a],l=t[2*n],h=t[2*n+1],p=t[2*s],f=t[2*s+1],v=t[2*c],d=t[2*c+1],m=!1;if(ae._convex(l,h,p,f,v,d)){m=!0;for(var y=0;y<a;y++){var A=i[y];if(!(A==n||A==s||A==c)&&ae._PointInTriangle(t[2*A],t[2*A+1],l,h,p,f,v,d)){m=!1;break}}}if(m)r.push(n,s,c),i.splice((o+1)%a,1),a--,o=0;else if(o++>3*a)break}return r.push(i[0],i[1],i[2]),r};ae._PointInTriangle=function(t,e,r,i,o,a,n,s){var c=n-r,l=s-i,h=o-r,p=a-i,f=t-r,v=e-i,d=c*c+l*l,m=c*h+l*p,y=c*f+l*v,A=h*h+p*p,g=h*f+p*v,E=1/(d*A-m*m),w=(A*y-m*g)*E,B=(d*g-m*y)*E;return w>=0&&B>=0&&w+B<1};ae._convex=function(t,e,r,i,o,a){return(e-i)*(o-r)+(r-t)*(a-i)>=0};var ia=ae,Dr=Nt,R=X.exports,oa=ia,Ye=dt;function dt(t){Array.isArray(arguments[0])&&(t={vertices:arguments[0],axes:arguments[1]},console.warn("The Convex constructor signature has changed. Please use the following format: new Convex({ vertices: [...], ... })")),t=t||{},this.vertices=[];for(var e=t.vertices!==void 0?t.vertices:[],r=0;r<e.length;r++){var i=R.create();R.copy(i,e[r]),this.vertices.push(i)}if(this.axes=[],t.axes)for(var r=0;r<t.axes.length;r++){var o=R.create();R.copy(o,t.axes[r]),this.axes.push(o)}else for(var r=0;r<this.vertices.length;r++){var a=this.vertices[r],n=this.vertices[(r+1)%this.vertices.length],s=R.create();R.sub(s,n,a),R.rotate90cw(s,s),R.normalize(s,s),this.axes.push(s)}if(this.centerOfMass=R.fromValues(0,0),this.triangles=[],this.vertices.length&&(this.updateTriangles(),this.updateCenterOfMass()),this.boundingRadius=0,t.type=Dr.CONVEX,Dr.call(this,t),this.updateBoundingRadius(),this.updateArea(),this.area<0)throw new Error("Convex vertices must be given in conter-clockwise winding.")}dt.prototype=new Dr;dt.prototype.constructor=dt;var aa=R.create(),na=R.create();dt.prototype.projectOntoLocalAxis=function(n,e){for(var r=null,i=null,o,a,n=aa,s=0;s<this.vertices.length;s++)o=this.vertices[s],a=R.dot(o,n),(r===null||a>r)&&(r=a),(i===null||a<i)&&(i=a);if(i>r){var c=i;i=r,r=c}R.set(e,i,r)};dt.prototype.projectOntoWorldAxis=function(t,e,r,i){var o=na;this.projectOntoLocalAxis(t,i),r!==0?R.rotate(o,t,r):o=t;var a=R.dot(e,o);R.set(i,i[0]+a,i[1]+a)};dt.prototype.updateTriangles=function(){this.triangles.length=0;for(var t=[],e=0;e<this.vertices.length;e++){var r=this.vertices[e];t.push(r[0],r[1])}for(var i=oa.Triangulate(t),e=0;e<i.length;e+=3){var o=i[e],a=i[e+1],n=i[e+2];this.triangles.push([o,a,n])}};var sa=R.create(),ca=R.create(),la=R.create(),ha=R.create(),ua=R.create();R.create();R.create();R.create();R.create();dt.prototype.updateCenterOfMass=function(){var t=this.triangles,e=this.vertices,r=this.centerOfMass,i=sa,o=la,a=ha,n=ua,s=ca;R.set(r,0,0);for(var c=0,l=0;l!==t.length;l++){var h=t[l],o=e[h[0]],a=e[h[1]],n=e[h[2]];R.centroid(i,o,a,n);var p=dt.triangleArea(o,a,n);c+=p,R.scale(s,i,p),R.add(r,r,s)}R.scale(r,r,1/c)};dt.prototype.computeMomentOfInertia=function(t){for(var e=0,r=0,i=this.vertices.length,o=i-1,a=0;a<i;o=a,a++){var n=this.vertices[o],s=this.vertices[a],c=Math.abs(R.crossLength(n,s)),l=R.dot(s,s)+R.dot(s,n)+R.dot(n,n);e+=c*l,r+=c}return t/6*(e/r)};dt.prototype.updateBoundingRadius=function(){for(var t=this.vertices,e=0,r=0;r!==t.length;r++){var i=R.squaredLength(t[r]);i>e&&(e=i)}this.boundingRadius=Math.sqrt(e)};dt.triangleArea=function(t,e,r){return((e[0]-t[0])*(r[1]-t[1])-(r[0]-t[0])*(e[1]-t[1]))*.5};dt.prototype.updateArea=function(){this.updateTriangles(),this.area=0;for(var t=this.triangles,e=this.vertices,r=0;r!==t.length;r++){var i=t[r],o=e[i[0]],a=e[i[1]],n=e[i[2]],s=dt.triangleArea(o,a,n);this.area+=s}};dt.prototype.computeAABB=function(t,e,r){t.setFromPoints(this.vertices,e,r,0)};var pa=R.create(),da=R.create(),fa=R.create();dt.prototype.raycast=function(t,e,r,i){var o=pa,a=da,n=fa,s=this.vertices;R.toLocalFrame(o,e.from,r,i),R.toLocalFrame(a,e.to,r,i);for(var c=s.length,l=0;l<c&&!t.shouldStop(e);l++){var h=s[l],p=s[(l+1)%c],f=R.getLineSegmentsIntersectionFraction(o,a,h,p);f>=0&&(R.sub(n,p,h),R.rotate(n,n,-Math.PI/2+i),R.normalize(n,n),e.reportIntersection(t,f,n,l))}};var qr,Fi;function wr(){if(Fi)return qr;Fi=1,qr=e;var t=X.exports;pi();function e(n){n=n||{},this.from=n.from?t.fromValues(n.from[0],n.from[1]):t.create(),this.to=n.to?t.fromValues(n.to[0],n.to[1]):t.create(),this.checkCollisionResponse=n.checkCollisionResponse!==void 0?n.checkCollisionResponse:!0,this.skipBackfaces=!!n.skipBackfaces,this.collisionMask=n.collisionMask!==void 0?n.collisionMask:-1,this.collisionGroup=n.collisionGroup!==void 0?n.collisionGroup:-1,this.mode=n.mode!==void 0?n.mode:e.ANY,this.callback=n.callback||function(s){},this.direction=t.create(),this.length=1,this.update()}e.prototype.constructor=e,e.CLOSEST=1,e.ANY=2,e.ALL=4,e.prototype.update=function(){var n=this.direction;t.sub(n,this.to,this.from),this.length=t.length(n),t.normalize(n,n)},e.prototype.intersectBodies=function(n,s){for(var c=0,l=s.length;!n.shouldStop(this)&&c<l;c++){var h=s[c],p=h.getAABB();(p.overlapsRay(this)>=0||p.containsPoint(this.from))&&this.intersectBody(n,h)}};var r=t.create();e.prototype.intersectBody=function(n,s){var c=this.checkCollisionResponse;if(!(c&&!s.collisionResponse))for(var l=r,h=0,p=s.shapes.length;h<p;h++){var f=s.shapes[h];if(!(c&&!f.collisionResponse)&&!((this.collisionGroup&f.collisionMask)===0||(f.collisionGroup&this.collisionMask)===0)){t.rotate(l,f.position,s.angle),t.add(l,l,s.position);var v=f.angle+s.angle;if(this.intersectShape(n,f,v,l,s),n.shouldStop(this))break}}},e.prototype.intersectShape=function(n,s,c,l,h){var p=this.from,f=a(p,this.direction,l);f>s.boundingRadius*s.boundingRadius||(this._currentBody=h,this._currentShape=s,s.raycast(n,this,l,c),this._currentBody=this._currentShape=null)},e.prototype.getAABB=function(n){var s=this.to,c=this.from;t.set(n.lowerBound,Math.min(s[0],c[0]),Math.min(s[1],c[1])),t.set(n.upperBound,Math.max(s[0],c[0]),Math.max(s[1],c[1]))},t.create(),e.prototype.reportIntersection=function(n,s,c,l){this.from,this.to;var h=this._currentShape,p=this._currentBody;if(!(this.skipBackfaces&&t.dot(c,this.direction)>0))switch(this.mode){case e.ALL:n.set(c,h,p,s,l),this.callback(n);break;case e.CLOSEST:(s<n.fraction||!n.hasHit())&&n.set(c,h,p,s,l);break;case e.ANY:n.set(c,h,p,s,l);break}};var i=t.create(),o=t.create();function a(n,s,c){t.sub(i,c,n);var l=t.dot(i,s);return t.scale(o,s,l),t.add(o,o,n),t.squaredDistance(c,o)}return qr}var Fr,Si;function pi(){if(Si)return Fr;Si=1;var t=X.exports,e=wr();Fr=r;function r(){this.normal=t.create(),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1}return r.prototype.reset=function(){t.set(this.normal,0,0),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1},r.prototype.getHitDistance=function(i){return t.distance(i.from,i.to)*this.fraction},r.prototype.hasHit=function(){return this.fraction!==-1},r.prototype.getHitPoint=function(i,o){t.lerp(i,o.from,o.to,this.fraction)},r.prototype.stop=function(){this.isStopped=!0},r.prototype.shouldStop=function(i){return this.isStopped||this.fraction!==-1&&i.mode===e.ANY},r.prototype.set=function(i,o,a,n,s){t.copy(this.normal,i),this.shape=o,this.body=a,this.fraction=n,this.faceIndex=s},Fr}var zr=function(){},Er=zr;zr.prototype={constructor:zr,on:function(t,e,r){e.context=r||this,this._listeners===void 0&&(this._listeners={});var i=this._listeners;return i[t]===void 0&&(i[t]=[]),i[t].indexOf(e)===-1&&i[t].push(e),this},has:function(t,e){if(this._listeners===void 0)return!1;var r=this._listeners;if(e){if(r[t]!==void 0&&r[t].indexOf(e)!==-1)return!0}else if(r[t]!==void 0)return!0;return!1},off:function(t,e){if(this._listeners===void 0)return this;var r=this._listeners,i=r[t].indexOf(e);return i!==-1&&r[t].splice(i,1),this},emit:function(t){if(this._listeners===void 0)return this;var e=this._listeners,r=e[t.type];if(r!==void 0){t.target=this;for(var i=0,o=r.length;i<o;i++){var a=r[i];a.call(a.context,t)}}return this}};var b=X.exports,va=ra,ma=Ye,ga=pi(),Mi=wr(),eo=hi,ro=Er,Re=L;function L(t){t=t||{},ro.call(this),this.id=t.id||++L._idCounter,this.world=null,this.shapes=[],this.mass=t.mass||0,this.invMass=0,this.inertia=0,this.invInertia=0,this.invMassSolve=0,this.invInertiaSolve=0,this.fixedRotation=!!t.fixedRotation,this.fixedX=!!t.fixedX,this.fixedY=!!t.fixedY,this.massMultiplier=b.create(),this.position=b.fromValues(0,0),t.position&&b.copy(this.position,t.position),this.interpolatedPosition=b.fromValues(0,0),this.interpolatedAngle=0,this.previousPosition=b.fromValues(0,0),this.previousAngle=0,this.velocity=b.fromValues(0,0),t.velocity&&b.copy(this.velocity,t.velocity),this.vlambda=b.fromValues(0,0),this.wlambda=0,this.angle=t.angle||0,this.angularVelocity=t.angularVelocity||0,this.force=b.create(),t.force&&b.copy(this.force,t.force),this.angularForce=t.angularForce||0,this.damping=typeof t.damping=="number"?t.damping:.1,this.angularDamping=typeof t.angularDamping=="number"?t.angularDamping:.1,this.type=L.STATIC,typeof t.type<"u"?this.type=t.type:t.mass?this.type=L.DYNAMIC:this.type=L.STATIC,this.boundingRadius=0,this.aabb=new eo,this.aabbNeedsUpdate=!0,this.allowSleep=t.allowSleep!==void 0?t.allowSleep:!0,this.wantsToSleep=!1,this.sleepState=L.AWAKE,this.sleepSpeedLimit=t.sleepSpeedLimit!==void 0?t.sleepSpeedLimit:.2,this.sleepTimeLimit=t.sleepTimeLimit!==void 0?t.sleepTimeLimit:1,this.gravityScale=t.gravityScale!==void 0?t.gravityScale:1,this.collisionResponse=t.collisionResponse!==void 0?t.collisionResponse:!0,this.idleTime=0,this.timeLastSleepy=0,this.ccdSpeedThreshold=t.ccdSpeedThreshold!==void 0?t.ccdSpeedThreshold:-1,this.ccdIterations=t.ccdIterations!==void 0?t.ccdIterations:10,this.concavePath=null,this._wakeUpAfterNarrowphase=!1,this.updateMassProperties()}L.prototype=new ro;L.prototype.constructor=L;L._idCounter=0;L.prototype.updateSolveMassProperties=function(){this.sleepState===L.SLEEPING||this.type===L.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve=0):(this.invMassSolve=this.invMass,this.invInertiaSolve=this.invInertia)};L.prototype.setDensity=function(t){var e=this.getArea();this.mass=e*t,this.updateMassProperties()};L.prototype.getArea=function(){for(var t=0,e=0;e<this.shapes.length;e++)t+=this.shapes[e].area;return t};L.prototype.getAABB=function(){return this.aabbNeedsUpdate&&this.updateAABB(),this.aabb};var Sr=new eo,ya=b.create();L.prototype.updateAABB=function(){for(var t=this.shapes,e=t.length,r=ya,i=this.angle,o=0;o!==e;o++){var a=t[o],n=a.angle+i;b.rotate(r,a.position,i),b.add(r,r,this.position),a.computeAABB(Sr,r,n),o===0?this.aabb.copy(Sr):this.aabb.extend(Sr)}this.aabbNeedsUpdate=!1};L.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=t.length,r=0,i=0;i!==e;i++){var o=t[i],a=b.length(o.position),n=o.boundingRadius;a+n>r&&(r=a+n)}this.boundingRadius=r};L.prototype.addShape=function(t,e,r){if(t.body)throw new Error("A shape can only be added to one body.");t.body=this,e?b.copy(t.position,e):b.set(t.position,0,0),t.angle=r||0,this.shapes.push(t),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0};L.prototype.removeShape=function(t){var e=this.shapes.indexOf(t);return e!==-1?(this.shapes.splice(e,1),this.aabbNeedsUpdate=!0,t.body=null,!0):!1};L.prototype.updateMassProperties=function(){if(this.type===L.STATIC||this.type===L.KINEMATIC)this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0;else{var t=this.shapes,e=t.length,r=this.mass/e,i=0;if(this.fixedRotation)this.inertia=Number.MAX_VALUE,this.invInertia=0;else{for(var o=0;o<e;o++){var a=t[o],n=b.squaredLength(a.position),s=a.computeMomentOfInertia(r);i+=s+r*n}this.inertia=i,this.invInertia=i>0?1/i:0}this.invMass=1/this.mass,b.set(this.massMultiplier,this.fixedX?0:1,this.fixedY?0:1)}};b.create();L.prototype.applyForce=function(t,e){if(b.add(this.force,this.force,t),e){var r=b.crossLength(e,t);this.angularForce+=r}};var Aa=b.create(),wa=b.create(),Ea=b.create();L.prototype.applyForceLocal=function(t,e){e=e||Ea;var r=Aa,i=wa;this.vectorToWorldFrame(r,t),this.vectorToWorldFrame(i,e),this.applyForce(r,i)};var ba=b.create();L.prototype.applyImpulse=function(t,e){if(this.type===L.DYNAMIC){var r=ba;if(b.scale(r,t,this.invMass),b.multiply(r,this.massMultiplier,r),b.add(this.velocity,r,this.velocity),e){var i=b.crossLength(e,t);i*=this.invInertia,this.angularVelocity+=i}}};var Ba=b.create(),xa=b.create(),Pa=b.create();L.prototype.applyImpulseLocal=function(t,e){e=e||Pa;var r=Ba,i=xa;this.vectorToWorldFrame(r,t),this.vectorToWorldFrame(i,e),this.applyImpulse(r,i)};L.prototype.toLocalFrame=function(t,e){b.toLocalFrame(t,e,this.position,this.angle)};L.prototype.toWorldFrame=function(t,e){b.toGlobalFrame(t,e,this.position,this.angle)};L.prototype.vectorToLocalFrame=function(t,e){b.vectorToLocalFrame(t,e,this.angle)};L.prototype.vectorToWorldFrame=function(t,e){b.vectorToGlobalFrame(t,e,this.angle)};L.prototype.fromPolygon=function(t,e){e=e||{};for(var r=this.shapes.length;r>=0;--r)this.removeShape(this.shapes[r]);var i=new va.Polygon;if(i.vertices=t,i.makeCCW(),typeof e.removeCollinearPoints=="number"&&i.removeCollinearPoints(e.removeCollinearPoints),typeof e.skipSimpleCheck>"u"&&!i.isSimple())return!1;this.concavePath=i.vertices.slice(0);for(var r=0;r<this.concavePath.length;r++){var o=[0,0];b.copy(o,this.concavePath[r]),this.concavePath[r]=o}var a;e.optimalDecomp?a=i.decomp():a=i.quickDecomp();for(var n=b.create(),r=0;r!==a.length;r++){for(var s=new ma({vertices:a[r].vertices}),c=0;c!==s.vertices.length;c++){var o=s.vertices[c];b.sub(o,o,s.centerOfMass)}b.scale(n,s.centerOfMass,1),s.updateTriangles(),s.updateCenterOfMass(),s.updateBoundingRadius(),this.addShape(s,n)}return this.adjustCenterOfMass(),this.aabbNeedsUpdate=!0,!0};b.fromValues(0,0);var Ca=b.fromValues(0,0),La=b.fromValues(0,0),qa=b.fromValues(0,0);L.prototype.adjustCenterOfMass=function(){var t=Ca,e=La,r=qa,i=0;b.set(e,0,0);for(var o=0;o!==this.shapes.length;o++){var a=this.shapes[o];b.scale(t,a.position,a.area),b.add(e,e,t),i+=a.area}b.scale(r,e,1/i);for(var o=0;o!==this.shapes.length;o++){var a=this.shapes[o];b.sub(a.position,a.position,r)}b.add(this.position,this.position,r);for(var o=0;this.concavePath&&o<this.concavePath.length;o++)b.sub(this.concavePath[o],this.concavePath[o],r);this.updateMassProperties(),this.updateBoundingRadius()};L.prototype.setZeroForce=function(){b.set(this.force,0,0),this.angularForce=0};L.prototype.resetConstraintVelocity=function(){var t=this,e=t.vlambda;b.set(e,0,0),t.wlambda=0};L.prototype.addConstraintVelocity=function(){var t=this,e=t.velocity;b.add(e,e,t.vlambda),t.angularVelocity+=t.wlambda};L.prototype.applyDamping=function(t){if(this.type===L.DYNAMIC){var e=this.velocity;b.scale(e,e,Math.pow(1-this.damping,t)),this.angularVelocity*=Math.pow(1-this.angularDamping,t)}};L.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=L.AWAKE,this.idleTime=0,t!==L.AWAKE&&this.emit(L.wakeUpEvent)};L.prototype.sleep=function(){this.sleepState=L.SLEEPING,this.angularVelocity=0,this.angularForce=0,b.set(this.velocity,0,0),b.set(this.force,0,0),this.emit(L.sleepEvent)};L.prototype.sleepTick=function(t,e,r){if(!(!this.allowSleep||this.type===L.SLEEPING)){this.wantsToSleep=!1,this.sleepState;var i=b.squaredLength(this.velocity)+Math.pow(this.angularVelocity,2),o=Math.pow(this.sleepSpeedLimit,2);i>=o?(this.idleTime=0,this.sleepState=L.AWAKE):(this.idleTime+=r,this.sleepState=L.SLEEPY),this.idleTime>this.sleepTimeLimit&&(e?this.wantsToSleep=!0:this.sleep())}};L.prototype.overlaps=function(t){return this.world.overlapKeeper.bodiesAreOverlapping(this,t)};var je=b.create(),xe=b.create();L.prototype.integrate=function(t){var e=this.invMass,r=this.force,i=this.position,o=this.velocity;b.copy(this.previousPosition,this.position),this.previousAngle=this.angle,this.fixedRotation||(this.angularVelocity+=this.angularForce*this.invInertia*t),b.scale(je,r,t*e),b.multiply(je,this.massMultiplier,je),b.add(o,je,o),this.integrateToTimeOfImpact(t)||(b.scale(xe,o,t),b.add(i,i,xe),this.fixedRotation||(this.angle+=this.angularVelocity*t)),this.aabbNeedsUpdate=!0};var _i=new ga,Ee=new Mi({mode:Mi.ALL}),Fa=b.create(),re=b.create(),be=b.create(),Mr=b.create();L.prototype.integrateToTimeOfImpact=function(t){if(this.ccdSpeedThreshold<0||b.squaredLength(this.velocity)<Math.pow(this.ccdSpeedThreshold,2))return!1;b.normalize(Fa,this.velocity),b.scale(re,this.velocity,t),b.add(re,re,this.position),b.sub(be,re,this.position);var e=this.angularVelocity*t,r=b.length(be),i=1,o,a=this;if(_i.reset(),Ee.callback=function(f){f.body!==a&&(o=f.body,f.getHitPoint(re,Ee),b.sub(be,re,a.position),i=b.length(be)/r,f.stop())},b.copy(Ee.from,this.position),b.copy(Ee.to,re),Ee.update(),this.world.raycast(_i,Ee),!o)return!1;var n=this.angle;b.copy(Mr,this.position);for(var s=0,c=0,l=0,h=i;h>=c&&s<this.ccdIterations;){s++,l=(h-c)/2,b.scale(xe,be,i),b.add(this.position,Mr,xe),this.angle=n+e*i,this.updateAABB();var p=this.aabb.overlaps(o.aabb)&&this.world.narrowphase.bodiesOverlap(this,o);p?c=l:h=l}return i=l,b.copy(this.position,Mr),this.angle=n,b.scale(xe,be,i),b.add(this.position,this.position,xe),this.fixedRotation||(this.angle+=e*i),!0};L.prototype.getVelocityAtPoint=function(t,e){return b.crossVZ(t,e,this.angularVelocity),b.subtract(t,this.velocity,t),t};L.sleepyEvent={type:"sleepy"};L.sleepEvent={type:"sleep"};L.wakeUpEvent={type:"wakeup"};L.DYNAMIC=1;L.STATIC=2;L.KINEMATIC=4;L.AWAKE=0;L.SLEEPY=1;L.SLEEPING=2;var Lt=nt,tt=X.exports,Sa=Vt;function nt(t,e,r,i){this.minForce=typeof r>"u"?-Number.MAX_VALUE:r,this.maxForce=typeof i>"u"?Number.MAX_VALUE:i,this.bodyA=t,this.bodyB=e,this.stiffness=nt.DEFAULT_STIFFNESS,this.relaxation=nt.DEFAULT_RELAXATION,this.G=new Sa.ARRAY_TYPE(6);for(var o=0;o<6;o++)this.G[o]=0;this.offset=0,this.a=0,this.b=0,this.epsilon=0,this.timeStep=1/60,this.needsUpdate=!0,this.multiplier=0,this.relativeVelocity=0,this.enabled=!0}nt.prototype.constructor=nt;nt.DEFAULT_STIFFNESS=1e6;nt.DEFAULT_RELAXATION=4;nt.prototype.update=function(){var t=this.stiffness,e=this.relaxation,r=this.timeStep;this.a=4/(r*(1+4*e)),this.b=4*e/(1+4*e),this.epsilon=4/(r*r*t*(1+4*e)),this.needsUpdate=!1};nt.prototype.gmult=function(t,e,r,i,o){return t[0]*e[0]+t[1]*e[1]+t[2]*r+t[3]*i[0]+t[4]*i[1]+t[5]*o};nt.prototype.computeB=function(t,e,r){var i=this.computeGW(),o=this.computeGq(),a=this.computeGiMf();return-o*t-i*e-a*r};var Ma=tt.create(),_a=tt.create();nt.prototype.computeGq=function(){var t=this.G,e=this.bodyA,r=this.bodyB;e.position,r.position;var i=e.angle,o=r.angle;return this.gmult(t,Ma,i,_a,o)+this.offset};nt.prototype.computeGW=function(){var t=this.G,e=this.bodyA,r=this.bodyB,i=e.velocity,o=r.velocity,a=e.angularVelocity,n=r.angularVelocity;return this.gmult(t,i,a,o,n)+this.relativeVelocity};nt.prototype.computeGWlambda=function(){var t=this.G,e=this.bodyA,r=this.bodyB,i=e.vlambda,o=r.vlambda,a=e.wlambda,n=r.wlambda;return this.gmult(t,i,a,o,n)};var tr=tt.create(),er=tt.create();nt.prototype.computeGiMf=function(){var t=this.bodyA,e=this.bodyB,r=t.force,i=t.angularForce,o=e.force,a=e.angularForce,n=t.invMassSolve,s=e.invMassSolve,c=t.invInertiaSolve,l=e.invInertiaSolve,h=this.G;return tt.scale(tr,r,n),tt.multiply(tr,t.massMultiplier,tr),tt.scale(er,o,s),tt.multiply(er,e.massMultiplier,er),this.gmult(h,tr,i*c,er,a*l)};nt.prototype.computeGiMGt=function(){var t=this.bodyA,e=this.bodyB,r=t.invMassSolve,i=e.invMassSolve,o=t.invInertiaSolve,a=e.invInertiaSolve,n=this.G;return n[0]*n[0]*r*t.massMultiplier[0]+n[1]*n[1]*r*t.massMultiplier[1]+n[2]*n[2]*o+n[3]*n[3]*i*e.massMultiplier[0]+n[4]*n[4]*i*e.massMultiplier[1]+n[5]*n[5]*a};var Ia=tt.create(),Ra=tt.create(),Va=tt.create();tt.create();tt.create();tt.create();nt.prototype.addToWlambda=function(t){var e=this.bodyA,r=this.bodyB,i=Ia,o=Ra,a=Va,n=e.invMassSolve,s=r.invMassSolve,c=e.invInertiaSolve,l=r.invInertiaSolve,h=this.G;o[0]=h[0],o[1]=h[1],a[0]=h[3],a[1]=h[4],tt.scale(i,o,n*t),tt.multiply(i,i,e.massMultiplier),tt.add(e.vlambda,e.vlambda,i),e.wlambda+=c*h[2]*t,tt.scale(i,a,s*t),tt.multiply(i,i,r.massMultiplier),tt.add(r.vlambda,r.vlambda,i),r.wlambda+=l*h[5]*t};nt.prototype.computeInvC=function(t){return 1/(this.computeGiMGt()+t)};var io=Lt,oo=ce;function ce(t,e,r){r=r||{},io.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=r.angle||0,this.ratio=typeof r.ratio=="number"?r.ratio:1,this.setRatio(this.ratio)}ce.prototype=new io;ce.prototype.constructor=ce;ce.prototype.computeGq=function(){return this.ratio*this.bodyA.angle-this.bodyB.angle+this.angle};ce.prototype.setRatio=function(t){var e=this.G;e[2]=t,e[5]=-1,this.ratio=t};ce.prototype.setMaxTorque=function(t){this.maxForce=t,this.minForce=-t};var Wr=X.exports,Be=Re,di=pt;function pt(t){this.type=t,this.result=[],this.world=null,this.boundingVolumeType=pt.AABB}pt.AABB=1;pt.BOUNDING_CIRCLE=2;pt.prototype.setWorld=function(t){this.world=t};pt.prototype.getCollisionPairs=function(t){};var Ii=Wr.create();pt.boundingRadiusCheck=function(t,e){Wr.sub(Ii,t.position,e.position);var r=Wr.squaredLength(Ii),i=t.boundingRadius+e.boundingRadius;return r<=i*i};pt.aabbCheck=function(t,e){return t.getAABB().overlaps(e.getAABB())};pt.prototype.boundingVolumeCheck=function(t,e){var r;switch(this.boundingVolumeType){case pt.BOUNDING_CIRCLE:r=pt.boundingRadiusCheck(t,e);break;case pt.AABB:r=pt.aabbCheck(t,e);break;default:throw new Error("Bounding volume type not recognized: "+this.boundingVolumeType)}return r};pt.canCollide=function(t,e){var r=Be.KINEMATIC,i=Be.STATIC;return!(t.type===i&&e.type===i||t.type===r&&e.type===i||t.type===i&&e.type===r||t.type===r&&e.type===r||t.sleepState===Be.SLEEPING&&e.sleepState===Be.SLEEPING||t.sleepState===Be.SLEEPING&&e.type===i||e.sleepState===Be.SLEEPING&&t.type===i)};pt.NAIVE=1;pt.SAP=2;var Xr=Nt,k=X.exports,ao=$t;function $t(t){typeof arguments[0]=="number"&&typeof arguments[1]=="number"&&(t={length:arguments[0],radius:arguments[1]},console.warn("The Capsule constructor signature has changed. Please use the following format: new Capsule({ radius: 1, length: 1 })")),t=t||{},this.length=t.length||1,this.radius=t.radius||1,t.type=Xr.CAPSULE,Xr.call(this,t)}$t.prototype=new Xr;$t.prototype.constructor=$t;$t.prototype.computeMomentOfInertia=function(t){var e=this.radius,r=this.length+e,i=e*2;return t*(i*i+r*r)/12};$t.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius+this.length/2};$t.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius+this.radius*2*this.length};var Ft=k.create();$t.prototype.computeAABB=function(t,e,r){var i=this.radius;k.set(Ft,this.length/2,0),r!==0&&k.rotate(Ft,Ft,r),k.set(t.upperBound,Math.max(Ft[0]+i,-Ft[0]+i),Math.max(Ft[1]+i,-Ft[1]+i)),k.set(t.lowerBound,Math.min(Ft[0]-i,-Ft[0]-i),Math.min(Ft[1]-i,-Ft[1]-i)),k.add(t.lowerBound,t.lowerBound,e),k.add(t.upperBound,t.upperBound,e)};var Na=k.create(),Ta=k.create(),Ga=k.create(),ka=k.create(),$a=k.fromValues(0,1);$t.prototype.raycast=function(t,e,r,i){var o=e.from,a=e.to;e.direction;for(var n=Na,s=Ta,c=Ga,l=ka,h=this.length/2,p=0;p<2;p++){var f=this.radius*(p*2-1);k.set(c,-h,f),k.set(l,h,f),k.toGlobalFrame(c,c,r,i),k.toGlobalFrame(l,l,r,i);var v=k.getLineSegmentsIntersectionFraction(o,a,c,l);if(v>=0&&(k.rotate(s,$a,i),k.scale(s,s,p*2-1),e.reportIntersection(t,v,s,-1),t.shouldStop(e)))return}for(var d=Math.pow(this.radius,2)+Math.pow(h,2),p=0;p<2;p++){k.set(c,h*(p*2-1),0),k.toGlobalFrame(c,c,r,i);var m=Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2),y=2*((a[0]-o[0])*(o[0]-c[0])+(a[1]-o[1])*(o[1]-c[1])),A=Math.pow(o[0]-c[0],2)+Math.pow(o[1]-c[1],2)-Math.pow(this.radius,2),v=Math.pow(y,2)-4*m*A;if(!(v<0))if(v===0){if(k.lerp(n,o,a,v),k.squaredDistance(n,r)>d&&(k.sub(s,n,c),k.normalize(s,s),e.reportIntersection(t,v,s,-1),t.shouldStop(e)))return}else{var g=Math.sqrt(v),E=1/(2*m),w=(-y-g)*E,B=(-y+g)*E;if(w>=0&&w<=1&&(k.lerp(n,o,a,w),k.squaredDistance(n,r)>d&&(k.sub(s,n,c),k.normalize(s,s),e.reportIntersection(t,w,s,-1),t.shouldStop(e)))||B>=0&&B<=1&&(k.lerp(n,o,a,B),k.squaredDistance(n,r)>d&&(k.sub(s,n,c),k.normalize(s,s),e.reportIntersection(t,B,s,-1),t.shouldStop(e))))return}}};var Yr=Nt,ft=X.exports,fi=Ot;function Ot(t){typeof arguments[0]=="number"&&(t={radius:arguments[0]},console.warn("The Circle constructor signature has changed. Please use the following format: new Circle({ radius: 1 })")),t=t||{},this.radius=t.radius||1,t.type=Yr.CIRCLE,Yr.call(this,t)}Ot.prototype=new Yr;Ot.prototype.constructor=Ot;Ot.prototype.computeMomentOfInertia=function(t){var e=this.radius;return t*e*e/2};Ot.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius};Ot.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius};Ot.prototype.computeAABB=function(t,e,r){var i=this.radius;ft.set(t.upperBound,i,i),ft.set(t.lowerBound,-i,-i),e&&(ft.add(t.lowerBound,t.lowerBound,e),ft.add(t.upperBound,t.upperBound,e))};var Oa=ft.create(),Ua=ft.create();Ot.prototype.raycast=function(t,e,r,i){var o=e.from,a=e.to,n=this.radius,s=Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2),c=2*((a[0]-o[0])*(o[0]-r[0])+(a[1]-o[1])*(o[1]-r[1])),l=Math.pow(o[0]-r[0],2)+Math.pow(o[1]-r[1],2)-Math.pow(n,2),h=Math.pow(c,2)-4*s*l,p=Oa,f=Ua;if(!(h<0))if(h===0)ft.lerp(p,o,a,h),ft.sub(f,p,r),ft.normalize(f,f),e.reportIntersection(t,h,f,-1);else{var v=Math.sqrt(h),d=1/(2*s),m=(-c-v)*d,y=(-c+v)*d;if(m>=0&&m<=1&&(ft.lerp(p,o,a,m),ft.sub(f,p,r),ft.normalize(f,f),e.reportIntersection(t,m,f,-1),t.shouldStop(e)))return;y>=0&&y<=1&&(ft.lerp(p,o,a,y),ft.sub(f,p,r),ft.normalize(f,f),e.reportIntersection(t,y,f,-1))}};var me=zt,Da=Vt;function zt(t,e,r,i){this.type=r,i=Da.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}zt.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")};zt.DISTANCE=1;zt.GEAR=2;zt.LOCK=3;zt.PRISMATIC=4;zt.REVOLUTE=5;zt.prototype.setStiffness=function(t){for(var e=this.equations,r=0;r!==e.length;r++){var i=e[r];i.stiffness=t,i.needsUpdate=!0}};zt.prototype.setRelaxation=function(t){for(var e=this.equations,r=0;r!==e.length;r++){var i=e[r];i.relaxation=t,i.needsUpdate=!0}};var no=Lt,mt=X.exports,vi=Le;function Le(t,e){no.call(this,t,e,0,Number.MAX_VALUE),this.contactPointA=mt.create(),this.penetrationVec=mt.create(),this.contactPointB=mt.create(),this.normalA=mt.create(),this.restitution=0,this.firstImpact=!1,this.shapeA=null,this.shapeB=null}Le.prototype=new no;Le.prototype.constructor=Le;Le.prototype.computeB=function(t,e,r){var i=this.bodyA,o=this.bodyB,a=this.contactPointA,n=this.contactPointB,s=i.position,c=o.position,l=this.penetrationVec,h=this.normalA,p=this.G,f=mt.crossLength(a,h),v=mt.crossLength(n,h);p[0]=-h[0],p[1]=-h[1],p[2]=-f,p[3]=h[0],p[4]=h[1],p[5]=v,mt.add(l,c,n),mt.sub(l,l,s),mt.sub(l,l,a);var d,m;this.firstImpact&&this.restitution!==0?(m=0,d=1/e*(1+this.restitution)*this.computeGW()):(m=mt.dot(h,l)+this.offset,d=this.computeGW());var y=this.computeGiMf(),A=-m*t-d*e-r*y;return A};var Ri=mt.create(),Vi=mt.create(),Ni=mt.create();Le.prototype.getVelocityAlongNormal=function(){return this.bodyA.getVelocityAtPoint(Ri,this.contactPointA),this.bodyB.getVelocityAtPoint(Vi,this.contactPointB),mt.subtract(Ni,Ri,Vi),mt.dot(this.normalA,Ni)};var Ve=br;function br(t){t=t||{},this.objects=[],t.size!==void 0&&this.resize(t.size)}br.prototype.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.create());return this};br.prototype.get=function(){var t=this.objects;return t.length?t.pop():this.create()};br.prototype.release=function(t){return this.destroy(t),this.objects.push(t),this};var za=vi,so=Ve,co=qe;function qe(){so.apply(this,arguments)}qe.prototype=new so;qe.prototype.constructor=qe;qe.prototype.create=function(){return new za};qe.prototype.destroy=function(t){return t.bodyA=t.bodyB=null,this};var mi=gi;function gi(t){this.id=t||gi.idCounter++}gi.idCounter=0;var Ti=mi,rr=Lt,lo=yi;function yi(t,e,r){if(r=r||{},!(t instanceof Ti)||!(e instanceof Ti))throw new Error("First two arguments must be Material instances.");this.id=yi.idCounter++,this.materialA=t,this.materialB=e,this.friction=typeof r.friction<"u"?Number(r.friction):.3,this.restitution=typeof r.restitution<"u"?Number(r.restitution):0,this.stiffness=typeof r.stiffness<"u"?Number(r.stiffness):rr.DEFAULT_STIFFNESS,this.relaxation=typeof r.relaxation<"u"?Number(r.relaxation):rr.DEFAULT_RELAXATION,this.frictionStiffness=typeof r.frictionStiffness<"u"?Number(r.frictionStiffness):rr.DEFAULT_STIFFNESS,this.frictionRelaxation=typeof r.frictionRelaxation<"u"?Number(r.frictionRelaxation):rr.DEFAULT_RELAXATION,this.surfaceVelocity=typeof r.surfaceVelocity<"u"?Number(r.surfaceVelocity):0,this.contactSkinSize=.005}yi.idCounter=0;var Hr=me,Wa=Lt,O=X.exports,Xa=Vt,Ya=le;function le(t,e,r){r=Xa.defaults(r,{localAnchorA:[0,0],localAnchorB:[0,0]}),Hr.call(this,t,e,Hr.DISTANCE,r),this.localAnchorA=O.fromValues(r.localAnchorA[0],r.localAnchorA[1]),this.localAnchorB=O.fromValues(r.localAnchorB[0],r.localAnchorB[1]);var i=this.localAnchorA,o=this.localAnchorB;if(this.distance=0,typeof r.distance=="number")this.distance=r.distance;else{var a=O.create(),n=O.create(),l=O.create();O.rotate(a,i,t.angle),O.rotate(n,o,e.angle),O.add(l,e.position,n),O.sub(l,l,a),O.sub(l,l,t.position),this.distance=O.length(l)}var s;typeof r.maxForce>"u"?s=Number.MAX_VALUE:s=r.maxForce;var c=new Wa(t,e,-s,s);this.equations=[c],this.maxForce=s;var l=O.create(),h=O.create(),p=O.create(),f=this;c.computeGq=function(){var v=this.bodyA,d=this.bodyB,m=v.position,y=d.position;return O.rotate(h,i,v.angle),O.rotate(p,o,d.angle),O.add(l,y,p),O.sub(l,l,h),O.sub(l,l,m),O.length(l)-f.distance},this.setMaxForce(s),this.upperLimitEnabled=!1,this.upperLimit=1,this.lowerLimitEnabled=!1,this.lowerLimit=0,this.position=0}le.prototype=new Hr;le.prototype.constructor=le;var yt=O.create(),_r=O.create(),Ir=O.create();le.prototype.update=function(){var t=this.equations[0],e=this.bodyA,r=this.bodyB;this.distance;var i=e.position,o=r.position,a=this.equations[0],n=t.G;O.rotate(_r,this.localAnchorA,e.angle),O.rotate(Ir,this.localAnchorB,r.angle),O.add(yt,o,Ir),O.sub(yt,yt,_r),O.sub(yt,yt,i),this.position=O.length(yt);var s=!1;if(this.upperLimitEnabled&&this.position>this.upperLimit&&(a.maxForce=0,a.minForce=-this.maxForce,this.distance=this.upperLimit,s=!0),this.lowerLimitEnabled&&this.position<this.lowerLimit&&(a.maxForce=this.maxForce,a.minForce=0,this.distance=this.lowerLimit,s=!0),(this.lowerLimitEnabled||this.upperLimitEnabled)&&!s){a.enabled=!1;return}a.enabled=!0,O.normalize(yt,yt);var c=O.crossLength(_r,yt),l=O.crossLength(Ir,yt);n[0]=-yt[0],n[1]=-yt[1],n[2]=-c,n[3]=yt[0],n[4]=yt[1],n[5]=l};le.prototype.setMaxForce=function(t){var e=this.equations[0];e.minForce=-t,e.maxForce=t};le.prototype.getMaxForce=function(){var t=this.equations[0];return t.maxForce};var De=X.exports,ho=Lt,Br=he;function he(t,e,r){ho.call(this,t,e,-r,r),this.contactPointA=De.create(),this.contactPointB=De.create(),this.t=De.create(),this.contactEquations=[],this.shapeA=null,this.shapeB=null,this.frictionCoefficient=.3}he.prototype=new ho;he.prototype.constructor=he;he.prototype.setSlipForce=function(t){this.maxForce=t,this.minForce=-t};he.prototype.getSlipForce=function(){return this.maxForce};he.prototype.computeB=function(t,e,r){this.bodyA,this.bodyB;var i=this.contactPointA,o=this.contactPointB,a=this.t,n=this.G;n[0]=-a[0],n[1]=-a[1],n[2]=-De.crossLength(i,a),n[3]=a[0],n[4]=a[1],n[5]=De.crossLength(o,a);var s=this.computeGW(),c=this.computeGiMf(),l=-s*e-r*c;return l};var Ha=Br,uo=Ve,po=Fe;function Fe(){uo.apply(this,arguments)}Fe.prototype=new uo;Fe.prototype.constructor=Fe;Fe.prototype.create=function(){return new Ha};Fe.prototype.destroy=function(t){return t.bodyA=t.bodyB=null,this};var Kr=me,Ka=oo,Za=ue;function ue(t,e,r){r=r||{},Kr.call(this,t,e,Kr.GEAR,r),this.ratio=r.ratio!==void 0?r.ratio:1,this.angle=r.angle!==void 0?r.angle:e.angle-this.ratio*t.angle,r.angle=this.angle,r.ratio=this.ratio,this.equations=[new Ka(t,e,r)],r.maxTorque!==void 0&&this.setMaxTorque(r.maxTorque)}ue.prototype=new Kr;ue.prototype.constructor=ue;ue.prototype.update=function(){var t=this.equations[0];t.ratio!==this.ratio&&t.setRatio(this.ratio),t.angle=this.angle};ue.prototype.setMaxTorque=function(t){this.equations[0].setMaxTorque(t)};ue.prototype.getMaxTorque=function(t){return this.equations[0].maxForce};var fo=Er,vo=Et;function Et(t,e){t=t||{},fo.call(this),this.type=e,this.equations=[],this.equationSortFunction=t.equationSortFunction||!1}Et.prototype=new fo;Et.prototype.constructor=Et;Et.prototype.solve=function(t,e){throw new Error("Solver.solve should be implemented by subclasses!")};var ir={bodies:[]};Et.prototype.solveIsland=function(t,e){this.removeAllEquations(),e.equations.length&&(this.addEquations(e.equations),ir.bodies.length=0,e.getBodies(ir.bodies),ir.bodies.length&&this.solve(t,ir))};Et.prototype.sortEquations=function(){this.equationSortFunction&&this.equations.sort(this.equationSortFunction)};Et.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)};Et.prototype.addEquations=function(t){for(var e=0,r=t.length;e!==r;e++){var i=t[e];i.enabled&&this.equations.push(i)}};Et.prototype.removeEquation=function(t){var e=this.equations.indexOf(t);e!==-1&&this.equations.splice(e,1)};Et.prototype.removeAllEquations=function(){this.equations.length=0};Et.GS=1;Et.ISLAND=2;var Gi=X.exports,Zr=vo,Ce=Vt,Ja=Br,mo=St;function St(t){Zr.call(this,t,Zr.GS),t=t||{},this.iterations=t.iterations||10,this.tolerance=t.tolerance||1e-7,this.arrayStep=30,this.lambda=new Ce.ARRAY_TYPE(this.arrayStep),this.Bs=new Ce.ARRAY_TYPE(this.arrayStep),this.invCs=new Ce.ARRAY_TYPE(this.arrayStep),this.useZeroRHS=!1,this.frictionIterations=t.frictionIterations!==void 0?0:t.frictionIterations,this.usedIterations=0}St.prototype=new Zr;St.prototype.constructor=St;function Qa(t){for(var e=t.length;e--;)t[e]=0}St.prototype.solve=function(t,e){this.sortEquations();var r=0,i=this.iterations,o=this.frictionIterations,a=this.equations,n=a.length,s=Math.pow(this.tolerance*n,2),c=e.bodies,l=e.bodies.length;Gi.add,Gi.set;var h=this.useZeroRHS,d=this.lambda;if(this.usedIterations=0,n)for(var A=0;A!==l;A++){var p=c[A];p.updateSolveMassProperties()}d.length<n&&(d=this.lambda=new Ce.ARRAY_TYPE(n+this.arrayStep),this.Bs=new Ce.ARRAY_TYPE(n+this.arrayStep),this.invCs=new Ce.ARRAY_TYPE(n+this.arrayStep)),Qa(d);for(var f=this.invCs,v=this.Bs,d=this.lambda,A=0;A!==a.length;A++){var m=a[A];(m.timeStep!==t||m.needsUpdate)&&(m.timeStep=t,m.update()),v[A]=m.computeB(m.a,m.b,t),f[A]=m.computeInvC(m.epsilon)}var m,y,A,g;if(n!==0){for(A=0;A!==l;A++){var p=c[A];p.resetConstraintVelocity()}if(o){for(r=0;r!==o;r++){for(y=0,g=0;g!==n;g++){m=a[g];var E=St.iterateEquation(g,m,m.epsilon,v,f,d,h,t,r);y+=Math.abs(E)}if(this.usedIterations++,y*y<=s)break}for(St.updateMultipliers(a,d,1/t),g=0;g!==n;g++){var w=a[g];if(w instanceof Ja){for(var B=0,T=0;T!==w.contactEquations.length;T++)B+=w.contactEquations[T].multiplier;B*=w.frictionCoefficient/w.contactEquations.length,w.maxForce=B,w.minForce=-B}}}for(r=0;r!==i;r++){for(y=0,g=0;g!==n;g++){m=a[g];var E=St.iterateEquation(g,m,m.epsilon,v,f,d,h,t,r);y+=Math.abs(E)}if(this.usedIterations++,y*y<=s)break}for(A=0;A!==l;A++)c[A].addConstraintVelocity();St.updateMultipliers(a,d,1/t)}};St.updateMultipliers=function(t,e,r){for(var i=t.length;i--;)t[i].multiplier=e[i]*r};St.iterateEquation=function(t,e,r,i,o,a,n,s,c){var l=i[t],h=o[t],p=a[t],f=e.computeGWlambda(),v=e.maxForce,d=e.minForce;n&&(l=0);var m=h*(l-f-r*p),y=p+m;return y<d*s?m=d*s-p:y>v*s&&(m=v*s-p),a[t]+=m,e.addToWlambda(m),m};var Jr=Nt,J=X.exports,ja=bt;function bt(t){if(Array.isArray(arguments[0])){if(t={heights:arguments[0]},typeof arguments[1]=="object")for(var e in arguments[1])t[e]=arguments[1][e];console.warn("The Heightfield constructor signature has changed. Please use the following format: new Heightfield({ heights: [...], ... })")}t=t||{},this.heights=t.heights?t.heights.slice(0):[],this.maxValue=t.maxValue||null,this.minValue=t.minValue||null,this.elementWidth=t.elementWidth||.1,(t.maxValue===void 0||t.minValue===void 0)&&this.updateMaxMinValues(),t.type=Jr.HEIGHTFIELD,Jr.call(this,t)}bt.prototype=new Jr;bt.prototype.constructor=bt;bt.prototype.updateMaxMinValues=function(){for(var t=this.heights,e=t[0],r=t[0],i=0;i!==t.length;i++){var o=t[i];o>e&&(e=o),o<r&&(r=o)}this.maxValue=e,this.minValue=r};bt.prototype.computeMomentOfInertia=function(t){return Number.MAX_VALUE};bt.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};bt.prototype.updateArea=function(){for(var t=this.heights,e=0,r=0;r<t.length-1;r++)e+=(t[r]+t[r+1])/2*this.elementWidth;this.area=e};var Te=[J.create(),J.create(),J.create(),J.create()];bt.prototype.computeAABB=function(t,e,r){J.set(Te[0],0,this.maxValue),J.set(Te[1],this.elementWidth*this.heights.length,this.maxValue),J.set(Te[2],this.elementWidth*this.heights.length,this.minValue),J.set(Te[3],0,this.minValue),t.setFromPoints(Te,e,r)};bt.prototype.getLineSegment=function(t,e,r){var i=this.heights,o=this.elementWidth;J.set(t,r*o,i[r]),J.set(e,(r+1)*o,i[r+1])};bt.prototype.getSegmentIndex=function(t){return Math.floor(t[0]/this.elementWidth)};bt.prototype.getClampedSegmentIndex=function(t){var e=this.getSegmentIndex(t);return e=Math.min(this.heights.length,Math.max(e,0)),e};J.create();var tn=J.create(),en=J.create(),rn=J.create(),on=J.create(),an=J.create();J.fromValues(0,1);bt.prototype.raycast=function(t,e,r,i){var o=e.from,a=e.to;e.direction;var n=tn,s=en,c=rn,l=on,h=an;J.toLocalFrame(l,o,r,i),J.toLocalFrame(h,a,r,i),this.getClampedSegmentIndex(l),this.getClampedSegmentIndex(h);for(var p=0;p<this.heights.length-1;p++){this.getLineSegment(s,c,p);var f=J.getLineSegmentsIntersectionFraction(l,h,s,c);if(f>=0&&(J.sub(n,c,s),J.rotate(n,n,i+Math.PI/2),J.normalize(n,n),e.reportIntersection(t,f,n,-1),t.shouldStop(e)))return}};var Qr=Nt,gt=X.exports,nn=Jt;function Jt(t){typeof arguments[0]=="number"&&(t={length:arguments[0]},console.warn("The Line constructor signature has changed. Please use the following format: new Line({ length: 1, ... })")),t=t||{},this.length=t.length||1,t.type=Qr.LINE,Qr.call(this,t)}Jt.prototype=new Qr;Jt.prototype.constructor=Jt;Jt.prototype.computeMomentOfInertia=function(t){return t*Math.pow(this.length,2)/12};Jt.prototype.updateBoundingRadius=function(){this.boundingRadius=this.length/2};var Rr=[gt.create(),gt.create()];Jt.prototype.computeAABB=function(t,e,r){var i=this.length/2;gt.set(Rr[0],-i,0),gt.set(Rr[1],i,0),t.setFromPoints(Rr,e,r,0)};gt.create();var sn=gt.create(),cn=gt.create(),ln=gt.create(),hn=gt.fromValues(0,1);Jt.prototype.raycast=function(t,e,r,i){var o=e.from,a=e.to,n=cn,s=ln,c=this.length/2;gt.set(n,-c,0),gt.set(s,c,0),gt.toGlobalFrame(n,n,r,i),gt.toGlobalFrame(s,s,r,i);var l=gt.getLineSegmentsIntersectionFraction(n,s,o,a);if(l>=0){var h=sn;gt.rotate(h,hn,i),e.reportIntersection(t,l,h,-1)}};var jr=me,G=X.exports,Vr=Lt,un=pe;function pe(t,e,r){r=r||{},jr.call(this,t,e,jr.LOCK,r);var i=typeof r.maxForce>"u"?Number.MAX_VALUE:r.maxForce;r.localAngleB;var o=new Vr(t,e,-i,i),a=new Vr(t,e,-i,i),n=new Vr(t,e,-i,i),s=G.create(),c=G.create(),l=this;o.computeGq=function(){return G.rotate(s,l.localOffsetB,t.angle),G.sub(c,e.position,t.position),G.sub(c,c,s),c[0]},a.computeGq=function(){return G.rotate(s,l.localOffsetB,t.angle),G.sub(c,e.position,t.position),G.sub(c,c,s),c[1]};var h=G.create(),p=G.create();n.computeGq=function(){return G.rotate(h,l.localOffsetB,e.angle-l.localAngleB),G.scale(h,h,-1),G.sub(c,t.position,e.position),G.add(c,c,h),G.rotate(p,h,-Math.PI/2),G.normalize(p,p),G.dot(c,p)},this.localOffsetB=G.create(),r.localOffsetB?G.copy(this.localOffsetB,r.localOffsetB):(G.sub(this.localOffsetB,e.position,t.position),G.rotate(this.localOffsetB,this.localOffsetB,-t.angle)),this.localAngleB=0,typeof r.localAngleB=="number"?this.localAngleB=r.localAngleB:this.localAngleB=e.angle-t.angle,this.equations.push(o,a,n),this.setMaxForce(i)}pe.prototype=new jr;pe.prototype.constructor=pe;pe.prototype.setMaxForce=function(t){for(var e=this.equations,r=0;r<this.equations.length;r++)e[r].maxForce=t,e[r].minForce=-t};pe.prototype.getMaxForce=function(){return this.equations[0].maxForce};var Nr=G.create(),Ge=G.create(),Ht=G.create(),pn=G.fromValues(1,0),dn=G.fromValues(0,1);pe.prototype.update=function(){var t=this.equations[0],e=this.equations[1],r=this.equations[2],i=this.bodyA,o=this.bodyB;G.rotate(Nr,this.localOffsetB,i.angle),G.rotate(Ge,this.localOffsetB,o.angle-this.localAngleB),G.scale(Ge,Ge,-1),G.rotate(Ht,Ge,Math.PI/2),G.normalize(Ht,Ht),t.G[0]=-1,t.G[1]=0,t.G[2]=-G.crossLength(Nr,pn),t.G[3]=1,e.G[0]=0,e.G[1]=-1,e.G[2]=-G.crossLength(Nr,dn),e.G[4]=1,r.G[0]=-Ht[0],r.G[1]=-Ht[1],r.G[3]=Ht[0],r.G[4]=Ht[1],r.G[5]=G.crossLength(Ge,Ht)};var fn=Vt,go=ge;function ge(){this.data={},this.keys=[]}ge.prototype.getKey=function(t,e){return t=t|0,e=e|0,(t|0)===(e|0)?-1:((t|0)>(e|0)?t<<16|e&65535:e<<16|t&65535)|0};ge.prototype.getByKey=function(t){return t=t|0,this.data[t]};ge.prototype.get=function(t,e){return this.data[this.getKey(t,e)]};ge.prototype.set=function(t,e,r){if(!r)throw new Error("No data!");var i=this.getKey(t,e);return this.data[i]||this.keys.push(i),this.data[i]=r,i};ge.prototype.reset=function(){for(var t=this.data,e=this.keys,r=e.length;r--;)delete t[e[r]];e.length=0};ge.prototype.copy=function(t){this.reset(),fn.appendArray(this.keys,t.keys);for(var e=t.keys.length;e--;){var r=t.keys[e];this.data[r]=t.data[r]}};var It=X.exports,vn=Nt,yo=Ye,Ao=Qt;function Qt(t){typeof arguments[0]=="number"&&typeof arguments[1]=="number"&&(t={width:arguments[0],height:arguments[1]},console.warn("The Rectangle has been renamed to Box and its constructor signature has changed. Please use the following format: new Box({ width: 1, height: 1, ... })")),t=t||{};var e=this.width=t.width||1,r=this.height=t.height||1,i=[It.fromValues(-e/2,-r/2),It.fromValues(e/2,-r/2),It.fromValues(e/2,r/2),It.fromValues(-e/2,r/2)],o=[It.fromValues(1,0),It.fromValues(0,1)];t.vertices=i,t.axes=o,t.type=vn.BOX,yo.call(this,t)}Qt.prototype=new yo;Qt.prototype.constructor=Qt;Qt.prototype.computeMomentOfInertia=function(t){var e=this.width,r=this.height;return t*(r*r+e*e)/12};Qt.prototype.updateBoundingRadius=function(){var t=this.width,e=this.height;this.boundingRadius=Math.sqrt(t*t+e*e)/2};It.create();It.create();It.create();It.create();Qt.prototype.computeAABB=function(t,e,r){t.setFromPoints(this.vertices,e,r,0)};Qt.prototype.updateArea=function(){this.area=this.width*this.height};var u=X.exports,x=u.sub,N=u.add,at=u.dot,mn=co,gn=po,yn=go,or=Lt,An=fi,wn=Ye,S=Nt,gr=Ao,wo=P,xr=u.fromValues(0,1),Tt=u.fromValues(0,0),te=u.fromValues(0,0),ye=u.fromValues(0,0),He=u.fromValues(0,0),Ke=u.fromValues(0,0),Ai=u.fromValues(0,0),Pr=u.fromValues(0,0),wi=u.fromValues(0,0),Ei=u.fromValues(0,0),bi=u.fromValues(0,0),Eo=u.fromValues(0,0),En=u.fromValues(0,0),Bi=u.fromValues(0,0),bo=u.fromValues(0,0),bn=u.fromValues(0,0),Bn=u.fromValues(0,0),xn=u.fromValues(0,0),Pn=u.fromValues(0,0),Bo=[];function P(){this.contactEquations=[],this.frictionEquations=[],this.enableFriction=!0,this.enabledEquations=!0,this.slipForce=10,this.frictionCoefficient=.3,this.surfaceVelocity=0,this.contactEquationPool=new mn({size:32}),this.frictionEquationPool=new gn({size:64}),this.restitution=0,this.stiffness=or.DEFAULT_STIFFNESS,this.relaxation=or.DEFAULT_RELAXATION,this.frictionStiffness=or.DEFAULT_STIFFNESS,this.frictionRelaxation=or.DEFAULT_RELAXATION,this.enableFrictionReduction=!0,this.collidingBodiesLastStep=new yn,this.contactSkinSize=.01}var Cn=u.create(),Ln=u.create();P.prototype.bodiesOverlap=function(t,e){for(var r=Cn,i=Ln,o=0,a=t.shapes.length;o!==a;o++){var n=t.shapes[o];t.toWorldFrame(r,n.position);for(var s=0,c=e.shapes.length;s!==c;s++){var l=e.shapes[s];if(e.toWorldFrame(i,l.position),this[n.type|l.type](t,n,r,n.angle+t.angle,e,l,i,l.angle+e.angle,!0))return!0}}return!1};P.prototype.collidedLastStep=function(t,e){var r=t.id|0,i=e.id|0;return!!this.collidingBodiesLastStep.get(r,i)};P.prototype.reset=function(){this.collidingBodiesLastStep.reset();for(var t=this.contactEquations,e=t.length;e--;){var r=t[e],i=r.bodyA.id,o=r.bodyB.id;this.collidingBodiesLastStep.set(i,o,!0)}for(var a=this.contactEquations,n=this.frictionEquations,s=0;s<a.length;s++)this.contactEquationPool.release(a[s]);for(var s=0;s<n.length;s++)this.frictionEquationPool.release(n[s]);this.contactEquations.length=this.frictionEquations.length=0};P.prototype.createContactEquation=function(t,e,r,i){var o=this.contactEquationPool.get();return o.bodyA=t,o.bodyB=e,o.shapeA=r,o.shapeB=i,o.restitution=this.restitution,o.firstImpact=!this.collidedLastStep(t,e),o.stiffness=this.stiffness,o.relaxation=this.relaxation,o.needsUpdate=!0,o.enabled=this.enabledEquations,o.offset=this.contactSkinSize,o};P.prototype.createFrictionEquation=function(t,e,r,i){var o=this.frictionEquationPool.get();return o.bodyA=t,o.bodyB=e,o.shapeA=r,o.shapeB=i,o.setSlipForce(this.slipForce),o.frictionCoefficient=this.frictionCoefficient,o.relativeVelocity=this.surfaceVelocity,o.enabled=this.enabledEquations,o.needsUpdate=!0,o.stiffness=this.frictionStiffness,o.relaxation=this.frictionRelaxation,o.contactEquations.length=0,o};P.prototype.createFrictionFromContact=function(t){var e=this.createFrictionEquation(t.bodyA,t.bodyB,t.shapeA,t.shapeB);return u.copy(e.contactPointA,t.contactPointA),u.copy(e.contactPointB,t.contactPointB),u.rotate90cw(e.t,t.normalA),e.contactEquations.push(t),e};P.prototype.createFrictionFromAverage=function(t){var e=this.contactEquations[this.contactEquations.length-1],r=this.createFrictionEquation(e.bodyA,e.bodyB,e.shapeA,e.shapeB),i=e.bodyA;e.bodyB,u.set(r.contactPointA,0,0),u.set(r.contactPointB,0,0),u.set(r.t,0,0);for(var o=0;o!==t;o++)e=this.contactEquations[this.contactEquations.length-1-o],e.bodyA===i?(u.add(r.t,r.t,e.normalA),u.add(r.contactPointA,r.contactPointA,e.contactPointA),u.add(r.contactPointB,r.contactPointB,e.contactPointB)):(u.sub(r.t,r.t,e.normalA),u.add(r.contactPointA,r.contactPointA,e.contactPointB),u.add(r.contactPointB,r.contactPointB,e.contactPointA)),r.contactEquations.push(e);var a=1/t;return u.scale(r.contactPointA,r.contactPointA,a),u.scale(r.contactPointB,r.contactPointB,a),u.normalize(r.t,r.t),u.rotate90cw(r.t,r.t),r};P.prototype[S.LINE|S.CONVEX]=P.prototype.convexLine=function(t,e,r,i,o,a,n,s,c){return c?!1:0};P.prototype[S.LINE|S.BOX]=P.prototype.lineBox=function(t,e,r,i,o,a,n,s,c){return c?!1:0};function ti(t,e){u.set(t.vertices[0],-e.length*.5,-e.radius),u.set(t.vertices[1],e.length*.5,-e.radius),u.set(t.vertices[2],e.length*.5,e.radius),u.set(t.vertices[3],-e.length*.5,e.radius)}var qn=new gr({width:1,height:1}),Fn=u.create();P.prototype[S.CAPSULE|S.CONVEX]=P.prototype[S.CAPSULE|S.BOX]=P.prototype.convexCapsule=function(t,e,r,i,o,a,n,s,c){var l=Fn;u.set(l,a.length/2,0),u.rotate(l,l,s),u.add(l,l,n);var h=this.circleConvex(o,a,l,s,t,e,r,i,c,a.radius);u.set(l,-a.length/2,0),u.rotate(l,l,s),u.add(l,l,n);var p=this.circleConvex(o,a,l,s,t,e,r,i,c,a.radius);if(c&&(h||p))return!0;var f=qn;ti(f,a);var v=this.convexConvex(t,e,r,i,o,f,n,s,c);return v+h+p};P.prototype[S.CAPSULE|S.LINE]=P.prototype.lineCapsule=function(t,e,r,i,o,a,n,s,c){return c?!1:0};var Sn=u.create(),Mn=u.create(),_n=new gr({width:1,height:1});P.prototype[S.CAPSULE|S.CAPSULE]=P.prototype.capsuleCapsule=function(t,e,r,i,o,a,n,s,c){for(var l,h=Sn,p=Mn,f=0,v=0;v<2;v++){u.set(h,(v===0?-1:1)*e.length/2,0),u.rotate(h,h,i),u.add(h,h,r);for(var d=0;d<2;d++){u.set(p,(d===0?-1:1)*a.length/2,0),u.rotate(p,p,s),u.add(p,p,n),this.enableFrictionReduction&&(l=this.enableFriction,this.enableFriction=!1);var m=this.circleCircle(t,e,h,i,o,a,p,s,c,e.radius,a.radius);if(this.enableFrictionReduction&&(this.enableFriction=l),c&&m)return!0;f+=m}}this.enableFrictionReduction&&(l=this.enableFriction,this.enableFriction=!1);var y=_n;ti(y,e);var A=this.convexCapsule(t,y,r,i,o,a,n,s,c);if(this.enableFrictionReduction&&(this.enableFriction=l),c&&A)return!0;if(f+=A,this.enableFrictionReduction){var l=this.enableFriction;this.enableFriction=!1}ti(y,a);var g=this.convexCapsule(o,y,n,s,t,e,r,i,c);return this.enableFrictionReduction&&(this.enableFriction=l),c&&g?!0:(f+=g,this.enableFrictionReduction&&f&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(f)),f)};P.prototype[S.LINE|S.LINE]=P.prototype.lineLine=function(t,e,r,i,o,a,n,s,c){return c?!1:0};P.prototype[S.PLANE|S.LINE]=P.prototype.planeLine=function(t,e,r,i,o,a,n,s,c){var l=Tt,h=te,p=ye,f=He,v=Ke,d=Ai,m=Pr,y=wi,A=Ei,g=Bo,E=0;u.set(l,-a.length/2,0),u.set(h,a.length/2,0),u.rotate(p,l,s),u.rotate(f,h,s),N(p,p,n),N(f,f,n),u.copy(l,p),u.copy(h,f),x(v,h,l),u.normalize(d,v),u.rotate90cw(A,d),u.rotate(y,xr,i),g[0]=l,g[1]=h;for(var w=0;w<g.length;w++){var B=g[w];x(m,B,r);var T=at(m,y);if(T<0){if(c)return!0;var M=this.createContactEquation(t,o,e,a);E++,u.copy(M.normalA,y),u.normalize(M.normalA,M.normalA),u.scale(m,y,T),x(M.contactPointA,B,m),x(M.contactPointA,M.contactPointA,t.position),x(M.contactPointB,B,n),N(M.contactPointB,M.contactPointB,n),x(M.contactPointB,M.contactPointB,o.position),this.contactEquations.push(M),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(M))}}return c?!1:(this.enableFrictionReduction||E&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(E)),E)};P.prototype[S.PARTICLE|S.CAPSULE]=P.prototype.particleCapsule=function(t,e,r,i,o,a,n,s,c){return this.circleLine(t,e,r,i,o,a,n,s,c,a.radius,0)};P.prototype[S.CIRCLE|S.LINE]=P.prototype.circleLine=function(t,e,r,i,o,a,n,s,c,p,f){var p=p||0,f=typeof f<"u"?f:e.radius,v=Tt,d=te,m=ye,y=He,A=Ke,g=Ai,E=Pr,w=wi,B=Ei,T=bi,M=Eo,F=En,W=Bi,Y=bo,C=Bo;u.set(w,-a.length/2,0),u.set(B,a.length/2,0),u.rotate(T,w,s),u.rotate(M,B,s),N(T,T,n),N(M,M,n),u.copy(w,T),u.copy(B,M),x(g,B,w),u.normalize(E,g),u.rotate90cw(A,E),x(F,r,w);var ot=at(F,A);x(y,w,n),x(W,r,n);var I=f+p;if(Math.abs(ot)<I){u.scale(v,A,ot),x(m,r,v),u.scale(d,A,at(A,W)),u.normalize(d,d),u.scale(d,d,p),N(m,m,d);var et=at(E,m),ee=at(E,w),Bt=at(E,B);if(et>ee&&et<Bt){if(c)return!0;var V=this.createContactEquation(t,o,e,a);return u.scale(V.normalA,v,-1),u.normalize(V.normalA,V.normalA),u.scale(V.contactPointA,V.normalA,f),N(V.contactPointA,V.contactPointA,r),x(V.contactPointA,V.contactPointA,t.position),x(V.contactPointB,m,n),N(V.contactPointB,V.contactPointB,n),x(V.contactPointB,V.contactPointB,o.position),this.contactEquations.push(V),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(V)),1}}C[0]=w,C[1]=B;for(var st=0;st<C.length;st++){var Gt=C[st];if(x(F,Gt,r),u.squaredLength(F)<Math.pow(I,2)){if(c)return!0;var V=this.createContactEquation(t,o,e,a);return u.copy(V.normalA,F),u.normalize(V.normalA,V.normalA),u.scale(V.contactPointA,V.normalA,f),N(V.contactPointA,V.contactPointA,r),x(V.contactPointA,V.contactPointA,t.position),x(V.contactPointB,Gt,n),u.scale(Y,V.normalA,-p),N(V.contactPointB,V.contactPointB,Y),N(V.contactPointB,V.contactPointB,n),x(V.contactPointB,V.contactPointB,o.position),this.contactEquations.push(V),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(V)),1}}return 0};P.prototype[S.CIRCLE|S.CAPSULE]=P.prototype.circleCapsule=function(t,e,r,i,o,a,n,s,c){return this.circleLine(t,e,r,i,o,a,n,s,c,a.radius)};P.prototype[S.CIRCLE|S.CONVEX]=P.prototype[S.CIRCLE|S.BOX]=P.prototype.circleConvex=function(t,e,r,i,o,a,n,s,c,h){for(var h=typeof h=="number"?h:e.radius,p=Tt,f=te,v=ye,d=He,m=Ke,y=bi,A=Eo,g=Bi,E=bo,w=bn,B=Bn,T=!1,M=Number.MAX_VALUE,F=a.vertices,W=0;W!==F.length+1;W++){var Y=F[W%F.length],C=F[(W+1)%F.length];if(u.rotate(p,Y,s),u.rotate(f,C,s),N(p,p,n),N(f,f,n),x(v,f,p),u.normalize(d,v),u.rotate90cw(m,d),u.scale(E,m,-e.radius),N(E,E,r),xo(E,a,n,s)){u.sub(w,p,E);var ot=Math.abs(u.dot(w,m));ot<M&&(u.copy(B,E),M=ot,u.scale(g,m,ot),u.add(g,g,E),T=!0)}}if(T){if(c)return!0;var I=this.createContactEquation(t,o,e,a);return u.sub(I.normalA,B,r),u.normalize(I.normalA,I.normalA),u.scale(I.contactPointA,I.normalA,h),N(I.contactPointA,I.contactPointA,r),x(I.contactPointA,I.contactPointA,t.position),x(I.contactPointB,g,n),N(I.contactPointB,I.contactPointB,n),x(I.contactPointB,I.contactPointB,o.position),this.contactEquations.push(I),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(I)),1}if(h>0)for(var W=0;W<F.length;W++){var et=F[W];if(u.rotate(A,et,s),N(A,A,n),x(y,A,r),u.squaredLength(y)<Math.pow(h,2)){if(c)return!0;var I=this.createContactEquation(t,o,e,a);return u.copy(I.normalA,y),u.normalize(I.normalA,I.normalA),u.scale(I.contactPointA,I.normalA,h),N(I.contactPointA,I.contactPointA,r),x(I.contactPointA,I.contactPointA,t.position),x(I.contactPointB,A,n),N(I.contactPointB,I.contactPointB,n),x(I.contactPointB,I.contactPointB,o.position),this.contactEquations.push(I),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(I)),1}}return 0};var In=u.create(),Rn=u.create(),Vn=u.create(),Nn=u.create();function xo(t,e,r,i){for(var o=In,a=Rn,n=Vn,s=Nn,c=t,l=e.vertices,h=null,p=0;p!==l.length+1;p++){var f=l[p%l.length],v=l[(p+1)%l.length];u.rotate(o,f,i),u.rotate(a,v,i),N(o,o,r),N(a,a,r),x(n,o,c),x(s,a,c);var d=u.crossLength(n,s);if(h===null&&(h=d),d*h<=0)return!1;h=d}return!0}P.prototype[S.PARTICLE|S.CONVEX]=P.prototype[S.PARTICLE|S.BOX]=P.prototype.particleConvex=function(t,e,r,i,o,a,n,s,c){var l=Tt,h=te,p=ye,f=He,v=Ke,d=Ai,m=Pr,y=bi,A=Bi,g=xn,E=Pn,w=Number.MAX_VALUE,B=!1,T=a.vertices;if(!xo(r,a,n,s))return 0;if(c)return!0;for(var M=0;M!==T.length+1;M++){var F=T[M%T.length],W=T[(M+1)%T.length];u.rotate(l,F,s),u.rotate(h,W,s),N(l,l,n),N(h,h,n),x(p,h,l),u.normalize(f,p),u.rotate90cw(v,f),x(y,r,l),at(y,v),x(d,l,n),x(m,r,n),u.sub(g,l,r);var Y=Math.abs(u.dot(g,v));Y<w&&(w=Y,u.scale(A,v,Y),u.add(A,A,r),u.copy(E,v),B=!0)}if(B){var C=this.createContactEquation(t,o,e,a);return u.scale(C.normalA,E,-1),u.normalize(C.normalA,C.normalA),u.set(C.contactPointA,0,0),N(C.contactPointA,C.contactPointA,r),x(C.contactPointA,C.contactPointA,t.position),x(C.contactPointB,A,n),N(C.contactPointB,C.contactPointB,n),x(C.contactPointB,C.contactPointB,o.position),this.contactEquations.push(C),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(C)),1}return 0};P.prototype[S.CIRCLE]=P.prototype.circleCircle=function(t,e,r,i,o,a,n,s,c,f,v){var p=Tt,f=f||e.radius,v=v||a.radius;x(p,r,n);var d=f+v;if(u.squaredLength(p)>Math.pow(d,2))return 0;if(c)return!0;var m=this.createContactEquation(t,o,e,a);return x(m.normalA,n,r),u.normalize(m.normalA,m.normalA),u.scale(m.contactPointA,m.normalA,f),u.scale(m.contactPointB,m.normalA,-v),N(m.contactPointA,m.contactPointA,r),x(m.contactPointA,m.contactPointA,t.position),N(m.contactPointB,m.contactPointB,n),x(m.contactPointB,m.contactPointB,o.position),this.contactEquations.push(m),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(m)),1};P.prototype[S.PLANE|S.CONVEX]=P.prototype[S.PLANE|S.BOX]=P.prototype.planeConvex=function(t,e,r,i,o,a,n,s,c){var l=Tt,h=te,p=ye,f=0;u.rotate(h,xr,i);for(var v=0;v!==a.vertices.length;v++){var d=a.vertices[v];if(u.rotate(l,d,s),N(l,l,n),x(p,l,r),at(p,h)<=0){if(c)return!0;f++;var m=this.createContactEquation(t,o,e,a);x(p,l,r),u.copy(m.normalA,h);var y=at(p,m.normalA);u.scale(p,m.normalA,y),x(m.contactPointB,l,o.position),x(m.contactPointA,l,p),x(m.contactPointA,m.contactPointA,t.position),this.contactEquations.push(m),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(m))}}return this.enableFrictionReduction&&this.enableFriction&&f&&this.frictionEquations.push(this.createFrictionFromAverage(f)),f};P.prototype[S.PARTICLE|S.PLANE]=P.prototype.particlePlane=function(t,e,r,i,o,a,n,s,c){var l=Tt,h=te;s=s||0,x(l,r,n),u.rotate(h,xr,s);var p=at(l,h);if(p>0)return 0;if(c)return!0;var f=this.createContactEquation(o,t,a,e);return u.copy(f.normalA,h),u.scale(l,f.normalA,p),x(f.contactPointA,r,l),x(f.contactPointA,f.contactPointA,o.position),x(f.contactPointB,r,t.position),this.contactEquations.push(f),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(f)),1};P.prototype[S.CIRCLE|S.PARTICLE]=P.prototype.circleParticle=function(t,e,r,i,o,a,n,s,c){var l=Tt;if(x(l,n,r),u.squaredLength(l)>Math.pow(e.radius,2))return 0;if(c)return!0;var h=this.createContactEquation(t,o,e,a);return u.copy(h.normalA,l),u.normalize(h.normalA,h.normalA),u.scale(h.contactPointA,h.normalA,e.radius),N(h.contactPointA,h.contactPointA,r),x(h.contactPointA,h.contactPointA,t.position),x(h.contactPointB,n,o.position),this.contactEquations.push(h),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(h)),1};var Tn=new An({radius:1}),Gn=u.create(),kn=u.create();u.create();P.prototype[S.PLANE|S.CAPSULE]=P.prototype.planeCapsule=function(t,e,r,i,o,a,n,s,c){var l=Gn,h=kn,p=Tn;u.set(l,-a.length/2,0),u.rotate(l,l,s),N(l,l,n),u.set(h,a.length/2,0),u.rotate(h,h,s),N(h,h,n),p.radius=a.radius;var f;this.enableFrictionReduction&&(f=this.enableFriction,this.enableFriction=!1);var v=this.circlePlane(o,p,l,0,t,e,r,i,c),d=this.circlePlane(o,p,h,0,t,e,r,i,c);if(this.enableFrictionReduction&&(this.enableFriction=f),c)return v||d;var m=v+d;return this.enableFrictionReduction&&m&&this.frictionEquations.push(this.createFrictionFromAverage(m)),m};P.prototype[S.CIRCLE|S.PLANE]=P.prototype.circlePlane=function(t,e,r,i,o,a,n,s,c){var l=t,h=e,p=r,f=o,v=n,d=s;d=d||0;var m=Tt,y=te,A=ye;x(m,p,v),u.rotate(y,xr,d);var g=at(y,m);if(g>h.radius)return 0;if(c)return!0;var E=this.createContactEquation(f,l,a,e);return u.copy(E.normalA,y),u.scale(E.contactPointB,E.normalA,-h.radius),N(E.contactPointB,E.contactPointB,p),x(E.contactPointB,E.contactPointB,l.position),u.scale(A,E.normalA,g),x(E.contactPointA,m,A),N(E.contactPointA,E.contactPointA,v),x(E.contactPointA,E.contactPointA,f.position),this.contactEquations.push(E),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(E)),1};P.prototype[S.CONVEX]=P.prototype[S.CONVEX|S.BOX]=P.prototype[S.BOX]=P.prototype.convexConvex=function(t,e,r,i,o,a,n,s,c,E){var h=Tt,p=te,f=ye,v=He,d=Ke,m=Pr,y=wi,A=Ei,g=0,E=typeof E=="number"?E:0,w=P.findSeparatingAxis(e,r,i,a,n,s,h);if(!w)return 0;x(y,n,r),at(h,y)>0&&u.scale(h,h,-1);var B=P.getClosestEdge(e,i,h,!0),T=P.getClosestEdge(a,s,h);if(B===-1||T===-1)return 0;for(var M=0;M<2;M++){var F=B,W=T,Y=e,C=a,ot=r,I=n,et=i,ee=s,Bt=t,V=o;if(M===0){var st;st=F,F=W,W=st,st=Y,Y=C,C=st,st=ot,ot=I,I=st,st=et,et=ee,ee=st,st=Bt,Bt=V,V=st}for(var Gt=W;Gt<W+2;Gt++){var Qe=C.vertices[(Gt+C.vertices.length)%C.vertices.length];u.rotate(p,Qe,ee),N(p,p,I);for(var Wt=0,xt=F-1;xt<F+2;xt++){var Xt=Y.vertices[(xt+Y.vertices.length)%Y.vertices.length],kt=Y.vertices[(xt+1+Y.vertices.length)%Y.vertices.length];u.rotate(f,Xt,et),u.rotate(v,kt,et),N(f,f,ot),N(v,v,ot),x(d,v,f),u.rotate90cw(A,d),u.normalize(A,A),x(y,p,f);var qt=at(A,y);(xt===F&&qt<=E||xt!==F&&qt<=0)&&Wt++}if(Wt>=3){if(c)return!0;var K=this.createContactEquation(Bt,V,Y,C);g++;var Xt=Y.vertices[F%Y.vertices.length],kt=Y.vertices[(F+1)%Y.vertices.length];u.rotate(f,Xt,et),u.rotate(v,kt,et),N(f,f,ot),N(v,v,ot),x(d,v,f),u.rotate90cw(K.normalA,d),u.normalize(K.normalA,K.normalA),x(y,p,f);var qt=at(K.normalA,y);u.scale(m,K.normalA,qt),x(K.contactPointA,p,ot),x(K.contactPointA,K.contactPointA,m),N(K.contactPointA,K.contactPointA,ot),x(K.contactPointA,K.contactPointA,Bt.position),x(K.contactPointB,p,I),N(K.contactPointB,K.contactPointB,I),x(K.contactPointB,K.contactPointB,V.position),this.contactEquations.push(K),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(K))}}}return this.enableFrictionReduction&&this.enableFriction&&g&&this.frictionEquations.push(this.createFrictionFromAverage(g)),g};var $n=u.fromValues(0,0);P.projectConvexOntoAxis=function(t,e,r,i,o){var a=null,n=null,s,c,l=$n;u.rotate(l,i,-r);for(var h=0;h<t.vertices.length;h++)s=t.vertices[h],c=at(s,l),(a===null||c>a)&&(a=c),(n===null||c<n)&&(n=c);if(n>a){var p=n;n=a,a=p}var f=at(e,i);u.set(o,n+f,a+f)};var On=u.fromValues(0,0),Un=u.fromValues(0,0),Dn=u.fromValues(0,0),zn=u.fromValues(0,0),Wn=u.fromValues(0,0),Xn=u.fromValues(0,0);P.findSeparatingAxis=function(t,e,r,i,o,a,n){var s=null,c=!1,l=!1,h=On,p=Un,f=Dn,v=zn,d=Wn,m=Xn;if(t instanceof gr&&i instanceof gr)for(var y=0;y!==2;y++){var A=t,g=r;y===1&&(A=i,g=a);for(var E=0;E!==2;E++){E===0?u.set(v,0,1):E===1&&u.set(v,1,0),g!==0&&u.rotate(v,v,g),P.projectConvexOntoAxis(t,e,r,v,d),P.projectConvexOntoAxis(i,o,a,v,m);var w=d,B=m;d[0]>m[0]&&(B=d,w=m);var T=B[0]-w[1];c=T<=0,(s===null||T>s)&&(u.copy(n,v),s=T,l=c)}}else for(var y=0;y!==2;y++){var A=t,g=r;y===1&&(A=i,g=a);for(var E=0;E!==A.vertices.length;E++){u.rotate(p,A.vertices[E],g),u.rotate(f,A.vertices[(E+1)%A.vertices.length],g),x(h,f,p),u.rotate90cw(v,h),u.normalize(v,v),P.projectConvexOntoAxis(t,e,r,v,d),P.projectConvexOntoAxis(i,o,a,v,m);var w=d,B=m;d[0]>m[0]&&(B=d,w=m);var T=B[0]-w[1];c=T<=0,(s===null||T>s)&&(u.copy(n,v),s=T,l=c)}}return l};var Yn=u.fromValues(0,0),Hn=u.fromValues(0,0),Kn=u.fromValues(0,0);P.getClosestEdge=function(t,e,r,i){var o=Yn,a=Hn,n=Kn;u.rotate(o,r,-e),i&&u.scale(o,o,-1);for(var s=-1,c=t.vertices.length,l=-1,h=0;h!==c;h++){x(a,t.vertices[(h+1)%c],t.vertices[h%c]),u.rotate90cw(n,a),u.normalize(n,n);var p=at(n,o);(s===-1||p>l)&&(s=h%c,l=p)}return s};var Zn=u.create(),Jn=u.create(),Qn=u.create(),jn=u.create(),ts=u.create(),es=u.create(),rs=u.create();P.prototype[S.CIRCLE|S.HEIGHTFIELD]=P.prototype.circleHeightfield=function(t,e,r,i,o,a,n,s,c,p){var h=a.heights,p=p||e.radius,f=a.elementWidth,v=Jn,d=Zn,m=ts,y=rs,A=es,g=Qn,E=jn,w=Math.floor((r[0]-p-n[0])/f),B=Math.ceil((r[0]+p-n[0])/f);w<0&&(w=0),B>=h.length&&(B=h.length-1);for(var T=h[w],M=h[B],F=w;F<B;F++)h[F]<M&&(M=h[F]),h[F]>T&&(T=h[F]);if(r[1]-p>T)return c?!1:0;for(var W=!1,F=w;F<B;F++){u.set(g,F*f,h[F]),u.set(E,(F+1)*f,h[F+1]),u.add(g,g,n),u.add(E,E,n),u.sub(A,E,g),u.rotate(A,A,Math.PI/2),u.normalize(A,A),u.scale(d,A,-p),u.add(d,d,r),u.sub(v,d,g);var Y=u.dot(v,A);if(d[0]>=g[0]&&d[0]<E[0]&&Y<=0){if(c)return!0;W=!0,u.scale(v,A,-Y),u.add(m,d,v),u.copy(y,A);var C=this.createContactEquation(o,t,a,e);u.copy(C.normalA,y),u.scale(C.contactPointB,C.normalA,-p),N(C.contactPointB,C.contactPointB,r),x(C.contactPointB,C.contactPointB,t.position),u.copy(C.contactPointA,m),u.sub(C.contactPointA,C.contactPointA,o.position),this.contactEquations.push(C),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(C))}}if(W=!1,p>0){for(var F=w;F<=B;F++)if(u.set(g,F*f,h[F]),u.add(g,g,n),u.sub(v,r,g),u.squaredLength(v)<Math.pow(p,2)){if(c)return!0;W=!0;var C=this.createContactEquation(o,t,a,e);u.copy(C.normalA,v),u.normalize(C.normalA,C.normalA),u.scale(C.contactPointB,C.normalA,-p),N(C.contactPointB,C.contactPointB,r),x(C.contactPointB,C.contactPointB,t.position),x(C.contactPointA,g,n),N(C.contactPointA,C.contactPointA,n),x(C.contactPointA,C.contactPointA,o.position),this.contactEquations.push(C),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(C))}}return W?1:0};var is=u.create(),os=u.create(),as=u.create(),ns=new wn({vertices:[u.create(),u.create(),u.create(),u.create()]});P.prototype[S.BOX|S.HEIGHTFIELD]=P.prototype[S.CONVEX|S.HEIGHTFIELD]=P.prototype.convexHeightfield=function(t,e,r,i,o,a,n,s,c){var l=a.heights,h=a.elementWidth,p=is,f=os,v=as,d=ns,m=Math.floor((t.aabb.lowerBound[0]-n[0])/h),y=Math.ceil((t.aabb.upperBound[0]-n[0])/h);m<0&&(m=0),y>=l.length&&(y=l.length-1);for(var A=l[m],g=l[y],E=m;E<y;E++)l[E]<g&&(g=l[E]),l[E]>A&&(A=l[E]);if(t.aabb.lowerBound[1]>A)return c?!1:0;for(var w=0,E=m;E<y;E++){u.set(p,E*h,l[E]),u.set(f,(E+1)*h,l[E+1]),u.add(p,p,n),u.add(f,f,n);var B=100;u.set(v,(f[0]+p[0])*.5,(f[1]+p[1]-B)*.5),u.sub(d.vertices[0],f,v),u.sub(d.vertices[1],p,v),u.copy(d.vertices[2],d.vertices[1]),u.copy(d.vertices[3],d.vertices[0]),d.vertices[2][1]-=B,d.vertices[3][1]-=B,w+=this.convexConvex(t,e,r,i,o,d,v,0,c)}return w};var ei=Nt,ut=X.exports,Po=Ut;function Ut(t){t=t||{},t.type=ei.PLANE,ei.call(this,t)}Ut.prototype=new ei;Ut.prototype.constructor=Ut;Ut.prototype.computeMomentOfInertia=function(t){return 0};Ut.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};Ut.prototype.computeAABB=function(t,e,r){var i=r%(2*Math.PI),o=ut.set,a=1e7,n=t.lowerBound,s=t.upperBound;o(n,-a,-a),o(s,a,a),i===0?s[1]=0:i===Math.PI/2?n[0]=0:i===Math.PI?n[1]=0:i===3*Math.PI/2&&(s[0]=0)};Ut.prototype.updateArea=function(){this.area=Number.MAX_VALUE};var ss=ut.create();ut.create();ut.create();var cs=ut.create(),ls=ut.create();Ut.prototype.raycast=function(t,e,r,i){var o=e.from,a=e.to,n=e.direction,s=ss,c=cs,l=ls;ut.set(c,0,1),ut.rotate(c,c,i),ut.sub(l,o,r);var h=ut.dot(l,c);ut.sub(l,a,r);var p=ut.dot(l,c);if(!(h*p>0)&&!(ut.squaredDistance(o,a)<h*h)){var f=ut.dot(c,n);ut.sub(s,o,r);var v=-ut.dot(c,s)/f/e.length;e.reportIntersection(t,v,c,-1)}};var ri=Nt,ki=X.exports,Co=de;function de(t){t=t||{},t.type=ri.PARTICLE,ri.call(this,t)}de.prototype=new ri;de.prototype.constructor=de;de.prototype.computeMomentOfInertia=function(t){return 0};de.prototype.updateBoundingRadius=function(){this.boundingRadius=0};de.prototype.computeAABB=function(t,e,r){ki.copy(t.lowerBound,e),ki.copy(t.upperBound,e)};var yr=di,hs=Se;function Se(){yr.call(this,yr.NAIVE)}Se.prototype=new yr;Se.prototype.constructor=Se;Se.prototype.getCollisionPairs=function(t){var e=t.bodies,r=this.result;r.length=0;for(var i=0,o=e.length;i!==o;i++)for(var a=e[i],n=0;n<i;n++){var s=e[n];yr.canCollide(a,s)&&this.boundingVolumeCheck(a,s)&&r.push(a,s)}return r};Se.prototype.aabbQuery=function(t,e,r){r=r||[];for(var i=t.bodies,o=0;o<i.length;o++){var a=i[o];a.aabbNeedsUpdate&&a.updateAABB(),a.aabb.overlaps(e)&&r.push(a)}return r};var Lo=Lt,qo=ze;function ze(t,e){Lo.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.relativeVelocity=1,this.ratio=1}ze.prototype=new Lo;ze.prototype.constructor=ze;ze.prototype.computeB=function(t,e,r){var i=this.G;i[2]=-1,i[5]=this.ratio;var o=this.computeGiMf(),a=this.computeGW(),n=-a*e-r*o;return n};var Fo=Lt,ne=X.exports,So=We;function We(t,e,r){r=r||{},Fo.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=r.angle||0;var i=this.G;i[2]=1,i[5]=-1}We.prototype=new Fo;We.prototype.constructor=We;var $i=ne.create(),Oi=ne.create(),us=ne.fromValues(1,0),ps=ne.fromValues(0,1);We.prototype.computeGq=function(){return ne.rotate($i,us,this.bodyA.angle+this.angle),ne.rotate(Oi,ps,this.bodyB.angle),ne.dot($i,Oi)};var ii=me,Ui=Lt,ds=qo,Di=So,D=X.exports,fs=Mt,ie=D.create(),oe=D.create(),oi=D.fromValues(1,0),ai=D.fromValues(0,1),Pt=D.create();function Mt(t,e,r){r=r||{},ii.call(this,t,e,ii.REVOLUTE,r);var i=this.maxForce=typeof r.maxForce<"u"?r.maxForce:Number.MAX_VALUE;this.pivotA=D.create(),this.pivotB=D.create(),r.worldPivot?(D.sub(this.pivotA,r.worldPivot,t.position),D.sub(this.pivotB,r.worldPivot,e.position),D.rotate(this.pivotA,this.pivotA,-t.angle),D.rotate(this.pivotB,this.pivotB,-e.angle)):(D.copy(this.pivotA,r.localPivotA),D.copy(this.pivotB,r.localPivotB));var o=this.equations=[new Ui(t,e,-i,i),new Ui(t,e,-i,i)],a=o[0],n=o[1],s=this;a.computeGq=function(){return D.rotate(ie,s.pivotA,t.angle),D.rotate(oe,s.pivotB,e.angle),D.add(Pt,e.position,oe),D.sub(Pt,Pt,t.position),D.sub(Pt,Pt,ie),D.dot(Pt,oi)},n.computeGq=function(){return D.rotate(ie,s.pivotA,t.angle),D.rotate(oe,s.pivotB,e.angle),D.add(Pt,e.position,oe),D.sub(Pt,Pt,t.position),D.sub(Pt,Pt,ie),D.dot(Pt,ai)},n.minForce=a.minForce=-i,n.maxForce=a.maxForce=i,this.motorEquation=new ds(t,e),this.motorEnabled=!1,this.angle=0,this.lowerLimitEnabled=!1,this.upperLimitEnabled=!1,this.lowerLimit=0,this.upperLimit=0,this.upperLimitEquation=new Di(t,e),this.lowerLimitEquation=new Di(t,e),this.upperLimitEquation.minForce=0,this.lowerLimitEquation.maxForce=0}Mt.prototype=new ii;Mt.prototype.constructor=Mt;Mt.prototype.setLimits=function(t,e){typeof t=="number"?(this.lowerLimit=t,this.lowerLimitEnabled=!0):(this.lowerLimit=t,this.lowerLimitEnabled=!1),typeof e=="number"?(this.upperLimit=e,this.upperLimitEnabled=!0):(this.upperLimit=e,this.upperLimitEnabled=!1)};Mt.prototype.update=function(){var t=this.bodyA,e=this.bodyB,r=this.pivotA,i=this.pivotB,o=this.equations;o[0],o[1];var a=o[0],n=o[1],s=this.upperLimit,c=this.lowerLimit,l=this.upperLimitEquation,h=this.lowerLimitEquation,p=this.angle=e.angle-t.angle;if(this.upperLimitEnabled&&p>s)l.angle=s,o.indexOf(l)===-1&&o.push(l);else{var f=o.indexOf(l);f!==-1&&o.splice(f,1)}if(this.lowerLimitEnabled&&p<c)h.angle=c,o.indexOf(h)===-1&&o.push(h);else{var f=o.indexOf(h);f!==-1&&o.splice(f,1)}D.rotate(ie,r,t.angle),D.rotate(oe,i,e.angle),a.G[0]=-1,a.G[1]=0,a.G[2]=-D.crossLength(ie,oi),a.G[3]=1,a.G[4]=0,a.G[5]=D.crossLength(oe,oi),n.G[0]=0,n.G[1]=-1,n.G[2]=-D.crossLength(ie,ai),n.G[3]=0,n.G[4]=1,n.G[5]=D.crossLength(oe,ai)};Mt.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)};Mt.prototype.disableMotor=function(){if(!!this.motorEnabled){var t=this.equations.indexOf(this.motorEquation);this.equations.splice(t,1),this.motorEnabled=!1}};Mt.prototype.motorIsEnabled=function(){return!!this.motorEnabled};Mt.prototype.setMotorSpeed=function(t){if(!!this.motorEnabled){var e=this.equations.indexOf(this.motorEquation);this.equations[e].relativeVelocity=t}};Mt.prototype.getMotorSpeed=function(){return this.motorEnabled?this.motorEquation.relativeVelocity:!1};var ni=me,zi=vi,Wi=Lt,_=X.exports,vs=So,ms=jt;function jt(t,e,r){r=r||{},ni.call(this,t,e,ni.PRISMATIC,r);var i=_.fromValues(0,0),o=_.fromValues(1,0),a=_.fromValues(0,0);r.localAnchorA&&_.copy(i,r.localAnchorA),r.localAxisA&&_.copy(o,r.localAxisA),r.localAnchorB&&_.copy(a,r.localAnchorB),this.localAnchorA=i,this.localAnchorB=a,this.localAxisA=o;var n=this.maxForce=typeof r.maxForce<"u"?r.maxForce:Number.MAX_VALUE,s=new Wi(t,e,-n,n),c=new _.create,l=new _.create,h=new _.create,p=new _.create;if(s.computeGq=function(){return _.dot(h,p)},s.updateJacobian=function(){var m=this.G,y=t.position,A=e.position;_.rotate(c,i,t.angle),_.rotate(l,a,e.angle),_.add(h,A,l),_.sub(h,h,y),_.sub(h,h,c),_.rotate(p,o,t.angle+Math.PI/2),m[0]=-p[0],m[1]=-p[1],m[2]=-_.crossLength(c,p)+_.crossLength(p,h),m[3]=p[0],m[4]=p[1],m[5]=_.crossLength(l,p)},this.equations.push(s),!r.disableRotationalLock){var f=new vs(t,e,-n);this.equations.push(f)}this.position=0,this.velocity=0,this.lowerLimitEnabled=typeof r.lowerLimit<"u",this.upperLimitEnabled=typeof r.upperLimit<"u",this.lowerLimit=typeof r.lowerLimit<"u"?r.lowerLimit:0,this.upperLimit=typeof r.upperLimit<"u"?r.upperLimit:1,this.upperLimitEquation=new zi(t,e),this.lowerLimitEquation=new zi(t,e),this.upperLimitEquation.minForce=this.lowerLimitEquation.minForce=0,this.upperLimitEquation.maxForce=this.lowerLimitEquation.maxForce=n,this.motorEquation=new Wi(t,e),this.motorEnabled=!1,this.motorSpeed=0;var v=this,d=this.motorEquation;d.computeGW,d.computeGq=function(){return 0},d.computeGW=function(){var m=this.G,y=this.bodyA,A=this.bodyB,g=y.velocity,E=A.velocity,w=y.angularVelocity,B=A.angularVelocity;return this.gmult(m,g,w,E,B)+v.motorSpeed}}jt.prototype=new ni;jt.prototype.constructor=jt;var At=_.create(),ar=_.create(),nr=_.create(),Tr=_.create(),Gr=_.create(),sr=_.create();jt.prototype.update=function(){var t=this.equations,e=t[0],r=this.upperLimit,i=this.lowerLimit,o=this.upperLimitEquation,a=this.lowerLimitEquation,n=this.bodyA,s=this.bodyB,c=this.localAxisA,l=this.localAnchorA,h=this.localAnchorB;e.updateJacobian(),_.rotate(At,c,n.angle),_.rotate(Tr,l,n.angle),_.add(ar,Tr,n.position),_.rotate(Gr,h,s.angle),_.add(nr,Gr,s.position);var p=this.position=_.dot(nr,At)-_.dot(ar,At);if(this.motorEnabled){var f=this.motorEquation.G;f[0]=At[0],f[1]=At[1],f[2]=_.crossLength(At,Gr),f[3]=-At[0],f[4]=-At[1],f[5]=-_.crossLength(At,Tr)}if(this.upperLimitEnabled&&p>r)_.scale(o.normalA,At,-1),_.sub(o.contactPointA,ar,n.position),_.sub(o.contactPointB,nr,s.position),_.scale(sr,At,r),_.add(o.contactPointA,o.contactPointA,sr),t.indexOf(o)===-1&&t.push(o);else{var v=t.indexOf(o);v!==-1&&t.splice(v,1)}if(this.lowerLimitEnabled&&p<i)_.scale(a.normalA,At,1),_.sub(a.contactPointA,ar,n.position),_.sub(a.contactPointB,nr,s.position),_.scale(sr,At,i),_.sub(a.contactPointB,a.contactPointB,sr),t.indexOf(a)===-1&&t.push(a);else{var v=t.indexOf(a);v!==-1&&t.splice(v,1)}};jt.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)};jt.prototype.disableMotor=function(){if(!!this.motorEnabled){var t=this.equations.indexOf(this.motorEquation);this.equations.splice(t,1),this.motorEnabled=!1}};jt.prototype.setLimits=function(t,e){typeof t=="number"?(this.lowerLimit=t,this.lowerLimitEnabled=!0):(this.lowerLimit=t,this.lowerLimitEnabled=!1),typeof e=="number"?(this.upperLimit=e,this.upperLimitEnabled=!0):(this.upperLimit=e,this.upperLimitEnabled=!1)};var gs=Vt,Ar=di,Mo=Rt;function Rt(){Ar.call(this,Ar.SAP),this.axisList=[],this.axisIndex=0;var t=this;this._addBodyHandler=function(e){t.axisList.push(e.body)},this._removeBodyHandler=function(e){var r=t.axisList.indexOf(e.body);r!==-1&&t.axisList.splice(r,1)}}Rt.prototype=new Ar;Rt.prototype.constructor=Rt;Rt.prototype.setWorld=function(t){this.axisList.length=0,gs.appendArray(this.axisList,t.bodies),t.off("addBody",this._addBodyHandler).off("removeBody",this._removeBodyHandler),t.on("addBody",this._addBodyHandler).on("removeBody",this._removeBodyHandler),this.world=t};Rt.sortAxisList=function(t,e){e=e|0;for(var r=1,i=t.length;r<i;r++){for(var o=t[r],a=r-1;a>=0&&!(t[a].aabb.lowerBound[e]<=o.aabb.lowerBound[e]);a--)t[a+1]=t[a];t[a+1]=o}return t};Rt.prototype.sortList=function(){var t=this.axisList,e=this.axisIndex;Rt.sortAxisList(t,e)};Rt.prototype.getCollisionPairs=function(t){var e=this.axisList,r=this.result,i=this.axisIndex;r.length=0;for(var o=e.length;o--;){var a=e[o];a.aabbNeedsUpdate&&a.updateAABB()}this.sortList();for(var n=0,s=e.length|0;n!==s;n++)for(var c=e[n],l=n+1;l<s;l++){var h=e[l],p=h.aabb.lowerBound[i]<=c.aabb.upperBound[i];if(!p)break;Ar.canCollide(c,h)&&this.boundingVolumeCheck(c,h)&&r.push(c,h)}return r};Rt.prototype.aabbQuery=function(t,e,r){r=r||[],this.sortList();var i=this.axisIndex,o="x";i===1&&(o="y"),i===2&&(o="z");var a=this.axisList;e.lowerBound[o],e.upperBound[o];for(var n=0;n<a.length;n++){var s=a[n];s.aabbNeedsUpdate&&s.updateAABB(),s.aabb.overlaps(e)&&r.push(s)}return r};var ys=Vt,xi=_o;function _o(t,e,r){r=ys.defaults(r,{stiffness:100,damping:1}),this.stiffness=r.stiffness,this.damping=r.damping,this.bodyA=t,this.bodyB=e}_o.prototype.applyForce=function(){};var vt=X.exports,Io=me,Xi=Br,As=Re,ws=Ze;function Ze(t,e){this.chassisBody=t,this.wheels=[],this.groundBody=new As({mass:0}),this.world=null;var r=this;this.preStepCallback=function(){r.update()}}Ze.prototype.addToWorld=function(t){this.world=t,t.addBody(this.groundBody),t.on("preStep",this.preStepCallback);for(var e=0;e<this.wheels.length;e++){var r=this.wheels[e];t.addConstraint(r)}};Ze.prototype.removeFromWorld=function(){var t=this.world;t.removeBody(this.groundBody),t.off("preStep",this.preStepCallback);for(var e=0;e<this.wheels.length;e++){var r=this.wheels[e];t.removeConstraint(r)}this.world=null};Ze.prototype.addWheel=function(t){var e=new Ne(this,t);return this.wheels.push(e),e};Ze.prototype.update=function(){for(var t=0;t<this.wheels.length;t++)this.wheels[t].update()};function Ne(t,e){e=e||{},this.vehicle=t,this.forwardEquation=new Xi(t.chassisBody,t.groundBody),this.sideEquation=new Xi(t.chassisBody,t.groundBody),this.steerValue=0,this.engineForce=0,this.setSideFriction(e.sideFriction!==void 0?e.sideFriction:5),this.localForwardVector=vt.fromValues(0,1),e.localForwardVector&&vt.copy(this.localForwardVector,e.localForwardVector),this.localPosition=vt.fromValues(0,0),e.localPosition&&vt.copy(this.localPosition,e.localPosition),Io.apply(this,t.chassisBody,t.groundBody),this.equations.push(this.forwardEquation,this.sideEquation),this.setBrakeForce(0)}Ne.prototype=new Io;Ne.prototype.setBrakeForce=function(t){this.forwardEquation.setSlipForce(t)};Ne.prototype.setSideFriction=function(t){this.sideEquation.setSlipForce(t)};var Yi=vt.create(),kr=vt.create();Ne.prototype.getSpeed=function(){return this.vehicle.chassisBody.vectorToWorldFrame(kr,this.localForwardVector),this.vehicle.chassisBody.getVelocityAtPoint(Yi,kr),vt.dot(Yi,kr)};var cr=vt.create();Ne.prototype.update=function(){this.vehicle.chassisBody.vectorToWorldFrame(this.forwardEquation.t,this.localForwardVector),vt.rotate(this.sideEquation.t,this.localForwardVector,Math.PI/2),this.vehicle.chassisBody.vectorToWorldFrame(this.sideEquation.t,this.sideEquation.t),vt.rotate(this.forwardEquation.t,this.forwardEquation.t,this.steerValue),vt.rotate(this.sideEquation.t,this.sideEquation.t,this.steerValue),this.vehicle.chassisBody.toWorldFrame(this.forwardEquation.contactPointB,this.localPosition),vt.copy(this.sideEquation.contactPointB,this.forwardEquation.contactPointB),this.vehicle.chassisBody.vectorToWorldFrame(this.forwardEquation.contactPointA,this.localPosition),vt.copy(this.sideEquation.contactPointA,this.forwardEquation.contactPointA),vt.normalize(cr,this.forwardEquation.t),vt.scale(cr,cr,this.engineForce),this.vehicle.chassisBody.applyForce(cr,this.forwardEquation.contactPointA)};var U=X.exports,Ro=xi,Es=Dt;function Dt(t,e,r){r=r||{},Ro.call(this,t,e,r),this.localAnchorA=U.fromValues(0,0),this.localAnchorB=U.fromValues(0,0),r.localAnchorA&&U.copy(this.localAnchorA,r.localAnchorA),r.localAnchorB&&U.copy(this.localAnchorB,r.localAnchorB),r.worldAnchorA&&this.setWorldAnchorA(r.worldAnchorA),r.worldAnchorB&&this.setWorldAnchorB(r.worldAnchorB);var i=U.create(),o=U.create();this.getWorldAnchorA(i),this.getWorldAnchorB(o);var a=U.distance(i,o);this.restLength=typeof r.restLength=="number"?r.restLength:a}Dt.prototype=new Ro;Dt.prototype.constructor=Dt;Dt.prototype.setWorldAnchorA=function(t){this.bodyA.toLocalFrame(this.localAnchorA,t)};Dt.prototype.setWorldAnchorB=function(t){this.bodyB.toLocalFrame(this.localAnchorB,t)};Dt.prototype.getWorldAnchorA=function(t){this.bodyA.toWorldFrame(t,this.localAnchorA)};Dt.prototype.getWorldAnchorB=function(t){this.bodyB.toWorldFrame(t,this.localAnchorB)};var bs=U.create(),Bs=U.create(),xs=U.create(),Ps=U.create(),Cs=U.create(),Ls=U.create(),qs=U.create(),Fs=U.create(),Ss=U.create();Dt.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,r=this.restLength,i=this.bodyA,o=this.bodyB,a=bs,n=Bs,s=xs,c=Ps,l=Ss,h=Cs,p=Ls,f=qs,v=Fs;this.getWorldAnchorA(h),this.getWorldAnchorB(p),U.sub(f,h,i.position),U.sub(v,p,o.position),U.sub(a,p,h);var d=U.len(a);U.normalize(n,a),U.sub(s,o.velocity,i.velocity),U.crossZV(l,o.angularVelocity,v),U.add(s,s,l),U.crossZV(l,i.angularVelocity,f),U.sub(s,s,l),U.scale(c,n,-t*(d-r)-e*U.dot(s,n)),U.sub(i.force,i.force,c),U.add(o.force,o.force,c);var m=U.crossLength(f,c),y=U.crossLength(v,c);i.angularForce-=m,o.angularForce+=y};var Vo=xi,Ms=Xe;function Xe(t,e,r){r=r||{},Vo.call(this,t,e,r),this.restAngle=typeof r.restAngle=="number"?r.restAngle:e.angle-t.angle}Xe.prototype=new Vo;Xe.prototype.constructor=Xe;Xe.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,r=this.restAngle,i=this.bodyA,o=this.bodyB,a=o.angle-i.angle,n=o.angularVelocity-i.angularVelocity,s=-t*(a-r)-e*n*0;i.angularForce-=s,o.angularForce+=s};const _s="p2",Is="0.7.1",Rs="A JavaScript 2D physics engine.",Vs="Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",Ns=["p2.js","p2","physics","engine","2d"],Ts="./src/p2.js",Gs={node:"*"},ks={type:"git",url:"https://github.com/schteppe/p2.js.git"},$s={url:"https://github.com/schteppe/p2.js/issues"},Os=[{type:"MIT"}],Us={grunt:"^0.4.5","grunt-contrib-jshint":"^0.11.2","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-uglify":"~0.4.0","grunt-contrib-watch":"~0.5.0","grunt-browserify":"~2.0.1","grunt-contrib-concat":"^0.4.0"},Ds={"poly-decomp":"0.1.1"},zs={name:_s,version:Is,description:Rs,author:Vs,keywords:Ns,main:Ts,engines:Gs,repository:ks,bugs:$s,licenses:Os,devDependencies:Us,dependencies:Ds};var Ws=si;function si(t,e,r,i){this.shapeA=e,this.shapeB=i,this.bodyA=t,this.bodyB=r}si.prototype.set=function(t,e,r,i){si.call(this,t,e,r,i)};var Xs=Ws,No=Ve,Ys=Me;function Me(){No.apply(this,arguments)}Me.prototype=new No;Me.prototype.constructor=Me;Me.prototype.create=function(){return new Xs};Me.prototype.destroy=function(t){return t.bodyA=t.bodyB=t.shapeA=t.shapeB=null,this};var $r=go,Hs=Ys,Ks=_t;function _t(){this.overlappingShapesLastState=new $r,this.overlappingShapesCurrentState=new $r,this.recordPool=new Hs({size:16}),this.tmpDict=new $r,this.tmpArray1=[]}_t.prototype.tick=function(){for(var t=this.overlappingShapesLastState,e=this.overlappingShapesCurrentState,r=t.keys.length;r--;){var i=t.keys[r],o=t.getByKey(i);e.getByKey(i),o&&this.recordPool.release(o)}t.reset(),t.copy(e),e.reset()};_t.prototype.setOverlapping=function(t,e,r,i){this.overlappingShapesLastState;var o=this.overlappingShapesCurrentState;if(!o.get(e.id,i.id)){var a=this.recordPool.get();a.set(t,e,r,i),o.set(e.id,i.id,a)}};_t.prototype.getNewOverlaps=function(t){return this.getDiff(this.overlappingShapesLastState,this.overlappingShapesCurrentState,t)};_t.prototype.getEndOverlaps=function(t){return this.getDiff(this.overlappingShapesCurrentState,this.overlappingShapesLastState,t)};_t.prototype.bodiesAreOverlapping=function(t,e){for(var r=this.overlappingShapesCurrentState,i=r.keys.length;i--;){var o=r.keys[i],a=r.data[o];if(a.bodyA===t&&a.bodyB===e||a.bodyA===e&&a.bodyB===t)return!0}return!1};_t.prototype.getDiff=function(t,e,i){var i=i||[],o=t,a=e;i.length=0;for(var n=a.keys.length;n--;){var s=a.keys[n],c=a.data[s];if(!c)throw new Error("Key "+s+" had no data!");var l=o.data[s];l||i.push(c)}return i};_t.prototype.isNewOverlap=function(t,e){var r=t.id|0,i=e.id|0,o=this.overlappingShapesLastState,a=this.overlappingShapesCurrentState;return!o.get(r,i)&&!!a.get(r,i)};_t.prototype.getNewBodyOverlaps=function(t){this.tmpArray1.length=0;var e=this.getNewOverlaps(this.tmpArray1);return this.getBodyDiff(e,t)};_t.prototype.getEndBodyOverlaps=function(t){this.tmpArray1.length=0;var e=this.getEndOverlaps(this.tmpArray1);return this.getBodyDiff(e,t)};_t.prototype.getBodyDiff=function(t,e){e=e||[];for(var r=this.tmpDict,i=t.length;i--;){var o=t[i];r.set(o.bodyA.id|0,o.bodyB.id|0,o)}for(i=r.keys.length;i--;){var o=r.getByKey(r.keys[i]);o&&e.push(o.bodyA,o.bodyB)}return r.reset(),e};var Zs=Re,Js=Je;function Je(){this.equations=[],this.bodies=[]}Je.prototype.reset=function(){this.equations.length=this.bodies.length=0};var ke=[];Je.prototype.getBodies=function(t){var e=t||[],r=this.equations;ke.length=0;for(var i=0;i!==r.length;i++){var o=r[i];ke.indexOf(o.bodyA.id)===-1&&(e.push(o.bodyA),ke.push(o.bodyA.id)),ke.indexOf(o.bodyB.id)===-1&&(e.push(o.bodyB),ke.push(o.bodyB.id))}return e};Je.prototype.wantsToSleep=function(){for(var t=0;t<this.bodies.length;t++){var e=this.bodies[t];if(e.type===Zs.DYNAMIC&&!e.wantsToSleep)return!1}return!0};Je.prototype.sleep=function(){for(var t=0;t<this.bodies.length;t++){var e=this.bodies[t];e.sleep()}return!0};var Qs=To;function To(t){this.body=t,this.neighbors=[],this.equations=[],this.visited=!1}To.prototype.reset=function(){this.equations.length=0,this.neighbors.length=0,this.visited=!1,this.body=null};var js=Qs,Go=Ve,tc=_e;function _e(){Go.apply(this,arguments)}_e.prototype=new Go;_e.prototype.constructor=_e;_e.prototype.create=function(){return new js};_e.prototype.destroy=function(t){return t.reset(),this};var ec=Js,ko=Ve,rc=Ie;function Ie(){ko.apply(this,arguments)}Ie.prototype=new ko;Ie.prototype.constructor=Ie;Ie.prototype.create=function(){return new ec};Ie.prototype.destroy=function(t){return t.reset(),this};var ic=tc,oc=rc,$o=Re,ac=fe;function fe(t){this.nodePool=new ic({size:16}),this.islandPool=new oc({size:8}),this.equations=[],this.islands=[],this.nodes=[],this.queue=[]}fe.getUnvisitedNode=function(t){for(var e=t.length,r=0;r!==e;r++){var i=t[r];if(!i.visited&&i.body.type===$o.DYNAMIC)return i}return!1};fe.prototype.visit=function(t,e,r){e.push(t.body);for(var i=t.equations.length,o=0;o!==i;o++){var a=t.equations[o];r.indexOf(a)===-1&&r.push(a)}};fe.prototype.bfs=function(t,e,r){var i=this.queue;for(i.length=0,i.push(t),t.visited=!0,this.visit(t,e,r);i.length;)for(var o=i.pop(),a;a=fe.getUnvisitedNode(o.neighbors);)a.visited=!0,this.visit(a,e,r),a.body.type===$o.DYNAMIC&&i.push(a)};fe.prototype.split=function(t){for(var e=t.bodies,r=this.nodes,i=this.equations;r.length;)this.nodePool.release(r.pop());for(var o=0;o!==e.length;o++){var a=this.nodePool.get();a.body=e[o],r.push(a)}for(var n=0;n!==i.length;n++){var s=i[n],o=e.indexOf(s.bodyA),c=e.indexOf(s.bodyB),l=r[o],h=r[c];l.neighbors.push(h),h.neighbors.push(l),l.equations.push(s),h.equations.push(s)}for(var p=this.islands,o=0;o<p.length;o++)this.islandPool.release(p[o]);p.length=0;for(var f;f=fe.getUnvisitedNode(r);){var v=this.islandPool.get();this.bfs(f,v.bodies,v.equations),p.push(v)}return p};var nc=mo;wr();var $=X.exports,sc=fi,cc=Ye,lc=Po,hc=ao,Hi=Co,Oo=Er,ht=Re,uc=mi,pc=lo,dc=hi,fc=Mo,vc=wo,se=Vt,mc=Ks,gc=ac,yc=z;function z(t){Oo.apply(this),t=t||{},this.springs=[],this.bodies=[],this.disabledBodyCollisionPairs=[],this.solver=t.solver||new nc,this.narrowphase=new vc,this.islandManager=new gc,this.gravity=$.fromValues(0,-9.78),t.gravity&&$.copy(this.gravity,t.gravity),this.frictionGravity=$.length(this.gravity)||10,this.useWorldGravityAsFrictionGravity=!0,this.useFrictionGravityOnZeroGravity=!0,this.broadphase=t.broadphase||new fc,this.broadphase.setWorld(this),this.constraints=[],this.defaultMaterial=new uc,this.defaultContactMaterial=new pc(this.defaultMaterial,this.defaultMaterial),this.lastTimeStep=1/60,this.applySpringForces=!0,this.applyDamping=!0,this.applyGravity=!0,this.solveConstraints=!0,this.contactMaterials=[],this.time=0,this.accumulator=0,this.stepping=!1,this.bodiesToBeRemoved=[],this.islandSplit=typeof t.islandSplit<"u"?!!t.islandSplit:!0,this.emitImpactEvent=!0,this._constraintIdCounter=0,this._bodyIdCounter=0,this.postStepEvent={type:"postStep"},this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.addSpringEvent={type:"addSpring",spring:null},this.impactEvent={type:"impact",bodyA:null,bodyB:null,shapeA:null,shapeB:null,contactEquation:null},this.postBroadphaseEvent={type:"postBroadphase",pairs:null},this.sleepMode=z.NO_SLEEPING,this.beginContactEvent={type:"beginContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null,contactEquations:[]},this.endContactEvent={type:"endContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null},this.preSolveEvent={type:"preSolve",contactEquations:null,frictionEquations:null},this.overlappingShapesLastState={keys:[]},this.overlappingShapesCurrentState={keys:[]},this.overlapKeeper=new mc}z.prototype=new Object(Oo.prototype);z.prototype.constructor=z;z.NO_SLEEPING=1;z.BODY_SLEEPING=2;z.ISLAND_SLEEPING=4;z.prototype.addConstraint=function(t){this.constraints.push(t)};z.prototype.addContactMaterial=function(t){this.contactMaterials.push(t)};z.prototype.removeContactMaterial=function(t){var e=this.contactMaterials.indexOf(t);e!==-1&&se.splice(this.contactMaterials,e,1)};z.prototype.getContactMaterial=function(t,e){for(var r=this.contactMaterials,i=0,o=r.length;i!==o;i++){var a=r[i];if(a.materialA.id===t.id&&a.materialB.id===e.id||a.materialA.id===e.id&&a.materialB.id===t.id)return a}return!1};z.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);e!==-1&&se.splice(this.constraints,e,1)};$.create();$.create();$.create();$.create();$.create();$.create();var Ac=$.create(),$e=$.fromValues(0,0),Oe=$.fromValues(0,0);$.fromValues(0,0);$.fromValues(0,0);z.prototype.step=function(t,e,r){if(r=r||10,e=e||0,e===0)this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var i=0;this.accumulator>=t&&i<r;)this.internalStep(t),this.time+=t,this.accumulator-=t,i++;for(var o=this.accumulator%t/t,a=0;a!==this.bodies.length;a++){var n=this.bodies[a];$.lerp(n.interpolatedPosition,n.previousPosition,n.position,o),n.interpolatedAngle=n.previousAngle+o*(n.angle-n.previousAngle)}}};var lr=[];z.prototype.internalStep=function(t){this.stepping=!0;var e=this.springs.length,r=this.springs,i=this.bodies,o=this.gravity,a=this.solver,n=this.bodies.length,s=this.broadphase,c=this.narrowphase,l=this.constraints,h=Ac;$.scale;var p=$.add;$.rotate;var f=this.islandManager;if(this.overlapKeeper.tick(),this.lastTimeStep=t,this.useWorldGravityAsFrictionGravity){var v=$.length(this.gravity);v===0&&this.useFrictionGravityOnZeroGravity||(this.frictionGravity=v)}if(this.applyGravity)for(var d=0;d!==n;d++){var m=i[d],y=m.force;m.type!==ht.DYNAMIC||m.sleepState===ht.SLEEPING||($.scale(h,o,m.mass*m.gravityScale),p(y,y,h))}if(this.applySpringForces)for(var d=0;d!==e;d++){var A=r[d];A.applyForce()}if(this.applyDamping)for(var d=0;d!==n;d++){var m=i[d];m.type===ht.DYNAMIC&&m.applyDamping(t)}for(var g=s.getCollisionPairs(this),E=this.disabledBodyCollisionPairs,d=E.length-2;d>=0;d-=2)for(var w=g.length-2;w>=0;w-=2)(E[d]===g[w]&&E[d+1]===g[w+1]||E[d+1]===g[w]&&E[d]===g[w+1])&&g.splice(w,2);var qt=l.length;for(d=0;d!==qt;d++){var B=l[d];if(!B.collideConnected)for(var w=g.length-2;w>=0;w-=2)(B.bodyA===g[w]&&B.bodyB===g[w+1]||B.bodyB===g[w]&&B.bodyA===g[w+1])&&g.splice(w,2)}this.postBroadphaseEvent.pairs=g,this.emit(this.postBroadphaseEvent),this.postBroadphaseEvent.pairs=null,c.reset(this);for(var d=0,T=g.length;d!==T;d+=2)for(var M=g[d],F=g[d+1],W=0,Y=M.shapes.length;W!==Y;W++)for(var C=M.shapes[W],ot=C.position,I=C.angle,et=0,ee=F.shapes.length;et!==ee;et++){var Bt=F.shapes[et],V=Bt.position,st=Bt.angle,Gt=this.defaultContactMaterial;if(C.material&&Bt.material){var Qe=this.getContactMaterial(C.material,Bt.material);Qe&&(Gt=Qe)}this.runNarrowphase(c,M,C,ot,I,F,Bt,V,st,Gt,this.frictionGravity)}for(var d=0;d!==n;d++){var Wt=i[d];Wt._wakeUpAfterNarrowphase&&(Wt.wakeUp(),Wt._wakeUpAfterNarrowphase=!1)}if(this.has("endContact")){this.overlapKeeper.getEndOverlaps(lr);for(var xt=this.endContactEvent,et=lr.length;et--;){var Xt=lr[et];xt.shapeA=Xt.shapeA,xt.shapeB=Xt.shapeB,xt.bodyA=Xt.bodyA,xt.bodyB=Xt.bodyB,this.emit(xt)}lr.length=0}var kt=this.preSolveEvent;kt.contactEquations=c.contactEquations,kt.frictionEquations=c.frictionEquations,this.emit(kt),kt.contactEquations=kt.frictionEquations=null;var qt=l.length;for(d=0;d!==qt;d++)l[d].update();if(c.contactEquations.length||c.frictionEquations.length||qt)if(this.islandSplit){for(f.equations.length=0,se.appendArray(f.equations,c.contactEquations),se.appendArray(f.equations,c.frictionEquations),d=0;d!==qt;d++)se.appendArray(f.equations,l[d].equations);f.split(this);for(var d=0;d!==f.islands.length;d++){var K=f.islands[d];K.equations.length&&a.solveIsland(t,K)}}else{for(a.addEquations(c.contactEquations),a.addEquations(c.frictionEquations),d=0;d!==qt;d++)a.addEquations(l[d].equations);this.solveConstraints&&a.solve(t,this),a.removeAllEquations()}for(var d=0;d!==n;d++){var Wt=i[d];Wt.integrate(t)}for(var d=0;d!==n;d++)i[d].setZeroForce();if(this.emitImpactEvent&&this.has("impact"))for(var Ae=this.impactEvent,d=0;d!==c.contactEquations.length;d++){var we=c.contactEquations[d];we.firstImpact&&(Ae.bodyA=we.bodyA,Ae.bodyB=we.bodyB,Ae.shapeA=we.shapeA,Ae.shapeB=we.shapeB,Ae.contactEquation=we,this.emit(Ae))}if(this.sleepMode===z.BODY_SLEEPING)for(d=0;d!==n;d++)i[d].sleepTick(this.time,!1,t);else if(this.sleepMode===z.ISLAND_SLEEPING&&this.islandSplit){for(d=0;d!==n;d++)i[d].sleepTick(this.time,!0,t);for(var d=0;d<this.islandManager.islands.length;d++){var K=this.islandManager.islands[d];K.wantsToSleep()&&K.sleep()}}this.stepping=!1;for(var Cr=this.bodiesToBeRemoved,d=0;d!==Cr.length;d++)this.removeBody(Cr[d]);Cr.length=0,this.emit(this.postStepEvent)};z.prototype.runNarrowphase=function(t,e,r,i,o,a,n,s,c,l,h){if((r.collisionGroup&n.collisionMask)!==0&&(n.collisionGroup&r.collisionMask)!==0){$.rotate($e,i,e.angle),$.rotate(Oe,s,a.angle),$.add($e,$e,e.position),$.add(Oe,Oe,a.position);var p=o+e.angle,f=c+a.angle;t.enableFriction=l.friction>0,t.frictionCoefficient=l.friction;var v;e.type===ht.STATIC||e.type===ht.KINEMATIC?v=a.mass:a.type===ht.STATIC||a.type===ht.KINEMATIC?v=e.mass:v=e.mass*a.mass/(e.mass+a.mass),t.slipForce=l.friction*h*v,t.restitution=l.restitution,t.surfaceVelocity=l.surfaceVelocity,t.frictionStiffness=l.frictionStiffness,t.frictionRelaxation=l.frictionRelaxation,t.stiffness=l.stiffness,t.relaxation=l.relaxation,t.contactSkinSize=l.contactSkinSize,t.enabledEquations=e.collisionResponse&&a.collisionResponse&&r.collisionResponse&&n.collisionResponse;var d=t[r.type|n.type],m=0;if(d){var y=r.sensor||n.sensor,A=t.frictionEquations.length;r.type<n.type?m=d.call(t,e,r,$e,p,a,n,Oe,f,y):m=d.call(t,a,n,Oe,f,e,r,$e,p,y);var g=t.frictionEquations.length-A;if(m){if(e.allowSleep&&e.type===ht.DYNAMIC&&e.sleepState===ht.SLEEPING&&a.sleepState===ht.AWAKE&&a.type!==ht.STATIC){var E=$.squaredLength(a.velocity)+Math.pow(a.angularVelocity,2),w=Math.pow(a.sleepSpeedLimit,2);E>=w*2&&(e._wakeUpAfterNarrowphase=!0)}if(a.allowSleep&&a.type===ht.DYNAMIC&&a.sleepState===ht.SLEEPING&&e.sleepState===ht.AWAKE&&e.type!==ht.STATIC){var B=$.squaredLength(e.velocity)+Math.pow(e.angularVelocity,2),T=Math.pow(e.sleepSpeedLimit,2);B>=T*2&&(a._wakeUpAfterNarrowphase=!0)}if(this.overlapKeeper.setOverlapping(e,r,a,n),this.has("beginContact")&&this.overlapKeeper.isNewOverlap(r,n)){var M=this.beginContactEvent;if(M.shapeA=r,M.shapeB=n,M.bodyA=e,M.bodyB=a,M.contactEquations.length=0,typeof m=="number")for(var F=t.contactEquations.length-m;F<t.contactEquations.length;F++)M.contactEquations.push(t.contactEquations[F]);this.emit(M)}if(typeof m=="number"&&g>1)for(var F=t.frictionEquations.length-g;F<t.frictionEquations.length;F++){var W=t.frictionEquations[F];W.setSlipForce(W.getSlipForce()/g)}}}}};z.prototype.addSpring=function(t){this.springs.push(t);var e=this.addSpringEvent;e.spring=t,this.emit(e),e.spring=null};z.prototype.removeSpring=function(t){var e=this.springs.indexOf(t);e!==-1&&se.splice(this.springs,e,1)};z.prototype.addBody=function(t){if(this.bodies.indexOf(t)===-1){this.bodies.push(t),t.world=this;var e=this.addBodyEvent;e.body=t,this.emit(e),e.body=null}};z.prototype.removeBody=function(t){if(this.stepping)this.bodiesToBeRemoved.push(t);else{t.world=null;var e=this.bodies.indexOf(t);e!==-1&&(se.splice(this.bodies,e,1),this.removeBodyEvent.body=t,t.resetConstraintVelocity(),this.emit(this.removeBodyEvent),this.removeBodyEvent.body=null)}};z.prototype.getBodyById=function(t){for(var e=this.bodies,r=0;r<e.length;r++){var i=e[r];if(i.id===t)return i}return!1};z.prototype.disableBodyCollision=function(t,e){this.disabledBodyCollisionPairs.push(t,e)};z.prototype.enableBodyCollision=function(t,e){for(var r=this.disabledBodyCollisionPairs,i=0;i<r.length;i+=2)if(r[i]===t&&r[i+1]===e||r[i+1]===t&&r[i]===e){r.splice(i,2);return}};z.prototype.clear=function(){this.time=0,this.solver&&this.solver.equations.length&&this.solver.removeAllEquations();for(var t=this.constraints,e=t.length-1;e>=0;e--)this.removeConstraint(t[e]);for(var r=this.bodies,e=r.length-1;e>=0;e--)this.removeBody(r[e]);for(var i=this.springs,e=i.length-1;e>=0;e--)this.removeSpring(i[e]);for(var o=this.contactMaterials,e=o.length-1;e>=0;e--)this.removeContactMaterial(o[e]);z.apply(this)};var wc=$.create();$.fromValues(0,0);var Ec=$.fromValues(0,0);z.prototype.hitTest=function(t,e,r){r=r||0;var i=new ht({position:t}),o=new Hi,a=t,n=0,s=wc,c=Ec;i.addShape(o);for(var l=this.narrowphase,h=[],p=0,f=e.length;p!==f;p++)for(var v=e[p],d=0,m=v.shapes.length;d!==m;d++){var y=v.shapes[d];$.rotate(s,y.position,v.angle),$.add(s,s,v.position);var A=y.angle+v.angle;(y instanceof sc&&l.circleParticle(v,y,s,A,i,o,a,n,!0)||y instanceof cc&&l.particleConvex(i,o,a,n,v,y,s,A,!0)||y instanceof lc&&l.particlePlane(i,o,a,n,v,y,s,A,!0)||y instanceof hc&&l.particleCapsule(i,o,a,n,v,y,s,A,!0)||y instanceof Hi&&$.squaredLength($.sub(c,s,t))<r*r)&&h.push(v)}return h};z.prototype.setGlobalStiffness=function(t){for(var e=this.constraints,r=0;r!==e.length;r++)for(var n=e[r],i=0;i!==n.equations.length;i++){var o=n.equations[i];o.stiffness=t,o.needsUpdate=!0}for(var a=this.contactMaterials,r=0;r!==a.length;r++){var n=a[r];n.stiffness=n.frictionStiffness=t}var n=this.defaultContactMaterial;n.stiffness=n.frictionStiffness=t};z.prototype.setGlobalRelaxation=function(t){for(var e=0;e!==this.constraints.length;e++)for(var o=this.constraints[e],r=0;r!==o.equations.length;r++){var i=o.equations[r];i.relaxation=t,i.needsUpdate=!0}for(var e=0;e!==this.contactMaterials.length;e++){var o=this.contactMaterials[e];o.relaxation=o.frictionRelaxation=t}var o=this.defaultContactMaterial;o.relaxation=o.frictionRelaxation=t};var Ki=new dc,Or=[];z.prototype.raycast=function(t,e){return e.getAABB(Ki),this.broadphase.aabbQuery(this,Ki,Or),e.intersectBodies(t,Or),Or.length=0,t.hasHit()};rt.exports={AABB:hi,AngleLockEquation:oo,Body:Re,Broadphase:di,Capsule:ao,Circle:fi,Constraint:me,ContactEquation:vi,ContactEquationPool:co,ContactMaterial:lo,Convex:Ye,DistanceConstraint:Ya,Equation:Lt,EventEmitter:Er,FrictionEquation:Br,FrictionEquationPool:po,GearConstraint:Za,GSSolver:mo,Heightfield:ja,Line:nn,LockConstraint:un,Material:mi,Narrowphase:wo,NaiveBroadphase:hs,Particle:Co,Plane:Po,Pool:Ve,RevoluteConstraint:fs,PrismaticConstraint:ms,Ray:wr(),RaycastResult:pi(),Box:Ao,RotationalVelocityEquation:qo,SAPBroadphase:Mo,Shape:Nt,Solver:vo,Spring:xi,TopDownVehicle:ws,LinearSpring:Es,RotationalSpring:Ms,Utils:Vt,World:yc,vec2:X.exports,version:zs.version};let ci=Z.make(1080,1920),hr=ci.scale(1),bc=`
# ########
  #nno.o.#
  #logglo#
  #logglo#
  ###.####

`,ur=16,pr=.98,dr=20,fr=1;const Bc=t=>{let e=[],r=[],i=new Map;t.split(`
`).forEach((o,a)=>{o.split("").forEach((n,s)=>{i.set(Z.make(s,a).key,n)})});for(let[o,a]of i){if(r.includes(o))continue;let n=Z.from_key(o);if(a==="#"){let s=Kt.make(-50,-50,100,100),c=new rt.exports.Body({position:n.scale(100).add(Z.make(100,100)).vs,mass:0});c.addShape(new rt.exports.Box({width:100,height:100})),e.push({bounding_box:s,body:c,pos:n,char:a,color:"hsl(0, 20%, 50%)"})}else if(a==="n"){r.push(n.key,n.right.key);let s=Kt.make(-50,-50,200,100).larger(-ur),c=s.vertices.map(h=>h.vs),l=new rt.exports.Body({fixedRotation:!0,position:n.scale(100).add(Z.make(100,100)).vs,angularDamping:fr,damping:pr,mass:dr});l.addShape(new rt.exports.Convex({vertices:c})),e.push({body:l,pos:n,char:a,bounding_box:s,color:"hsl(70, 50%, 50%)"})}else if(a==="o"){r.push(n.key);let s=Kt.make(-50,-50,100,100).larger(-ur),c=s.vertices.map(h=>h.vs),l=new rt.exports.Body({fixedRotation:!0,position:n.scale(100).add(Z.make(100,100)).vs,angularDamping:fr,damping:pr,mass:dr});l.addShape(new rt.exports.Convex({vertices:c})),e.push({body:l,pos:n,char:a,bounding_box:s,color:"hsl(90, 50%, 50%)"})}else if(a==="l"){r.push(n.key,n.down.key);let s=Kt.make(-50,-50,100,200).larger(-ur),c=s.vertices.map(h=>h.vs),l=new rt.exports.Body({fixedRotation:!0,position:n.scale(100).add(Z.make(100,100)).vs,angularDamping:fr,damping:pr,mass:dr});l.addShape(new rt.exports.Convex({vertices:c})),e.push({body:l,pos:n,char:a,bounding_box:s,color:"hsl(30, 50%, 50%)"})}else if(a==="g"){r.push(n.key,n.down.key,n.right.key,n.down.right.key);let s=Kt.make(-50,-50,200,200).larger(-ur),c=s.vertices.map(h=>h.vs),l=new rt.exports.Body({position:n.scale(100).add(Z.make(100,100)).vs,fixedRotation:!0,angularDamping:fr,damping:pr,mass:dr});l.addShape(new rt.exports.Convex({vertices:c})),e.push({body:l,pos:n,char:a,bounding_box:s,color:"hsl(50, 50%, 50%)"})}}return e},xc=t=>{let e=vr.make(1080,1920,t),r=new rt.exports.World({gravity:[0,0]}),i=Bc(bc.trim()),o=i.map(f=>f.body),a=new rt.exports.Body;o.forEach(f=>r.addBody(f));let n=mr.make(t),s,c,l=0,h=[],p=[];Xo({on_drag(f){if(h.forEach(v=>r.removeBody(v)),p.forEach(v=>r.removeConstraint(v)),h=[],p=[],f.m){let v=n.get_normal_at_abs_pos(f.e).mul(hr),d=n.get_normal_at_abs_pos(f.m).mul(hr);if(s)s=Ue.make(d.x,d.y,0);else{let[m]=r.hitTest(v.vs,o,1);if(m){let y=rt.exports.vec2.create();m.toLocalFrame(y,v.vs),y=Z.make(...y).scale(.9).vs,c=new rt.exports.RevoluteConstraint(a,m,{localPivotA:v.vs,localPivotB:y,maxForce:1e4*m.mass}),r.addBody(a),r.addConstraint(c),s=Ue.make(v.x,v.y,0)}}}},on_up(){r.removeConstraint(c),r.removeBody(a),s=void 0,l=zo.half}},t),Yo(()=>{n.$clear_bounds()}),Zi(f=>{if(s&&c){let[v,d]=s.vs;rt.exports.vec2.copy(c.pivotA,[v,d])}l>0&&(l-=f,l<=0&&i.forEach(v=>{let[d,m]=v.body.interpolatedPosition,y=Math.round(d/100)*100,A=Math.round(m/100)*100,g=new rt.exports.Body({mass:0,position:[y,A]}),E=new rt.exports.DistanceConstraint(g,v.body,{distance:0,maxForce:1e4*v.body.mass});E.setStiffness(1e7),E.setRelaxation(10),r.addBody(g),r.addConstraint(E),h.push(g),p.push(E)})),r.step(1/60,f/1e3,15),e.clear(),e.fr("hsl(0, 8%, 15%)",0,0,1080,1920),i.forEach(v=>{let{color:d,body:m,bounding_box:y}=v,[A,g]=m.interpolatedPosition,E=y.w,w=y.h;A+=y.x,g+=y.y;let B=Z.make(A,g).div(hr).mul(ci),T=Z.make(E,w).div(hr).mul(ci);e.fr(d,B.x,B.y,T.x,T.y),e.resetTransform()})})};xc(document.getElementById("app"));
